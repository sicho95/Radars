<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test GPX Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 2px solid #0ff;
        }
        input[type="file"] {
            padding: 10px;
            background: #333;
            color: #fff;
            border: 2px solid #0ff;
            border-radius: 5px;
            cursor: pointer;
        }
        #log {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 3px 0;
            padding: 2px 0;
            border-bottom: 1px solid #333;
        }
        .log-info { color: #0ff; }
        .log-success { color: #0f0; }
        .log-warning { color: #ff0; }
        .log-error { color: #f00; }
        #result {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Test GPX - Mode Debug</h1>

    <div class="section">
        <h2>ğŸ“ Charger un fichier GPX</h2>
        <input type="file" id="gpxFile" accept=".gpx">
    </div>

    <div class="section">
        <h2>ğŸ“‹ Journal de debug</h2>
        <div id="log"></div>
    </div>

    <div class="section">
        <h2>ğŸ“Š RÃ©sultats</h2>
        <div id="result">En attente d'un fichier GPX...</div>
    </div>

    <script>
        function addLog(msg, type = 'info') {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString('fr-FR');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${time}] ${msg}`;
            log.insertBefore(entry, log.firstChild);
            console.log(`[${type.toUpperCase()}]`, msg);
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const p1 = lat1 * Math.PI / 180;
            const p2 = lat2 * Math.PI / 180;
            const dlat = (lat2 - lat1) * Math.PI / 180;
            const dlon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dlat / 2) ** 2 + Math.cos(p1) * Math.cos(p2) * Math.sin(dlon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function parseGPXFile(xmlText) {
            addLog('ğŸ” DÃ©but du parsing GPX', 'info');

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

            // VÃ©rifier les erreurs de parsing
            const parserError = xmlDoc.querySelector('parsererror');
            if (parserError) {
                addLog('âŒ Erreur de parsing XML: ' + parserError.textContent, 'error');
                return null;
            }

            addLog('âœ… XML parsÃ© avec succÃ¨s', 'success');

            // Chercher les diffÃ©rents types de points
            const trkpts = xmlDoc.getElementsByTagName('trkpt');
            const rtepts = xmlDoc.getElementsByTagName('rtept');
            const wpts = xmlDoc.getElementsByTagName('wpt');

            addLog(`ğŸ“ TrouvÃ©: ${trkpts.length} track points, ${rtepts.length} route points, ${wpts.length} waypoints`, 'info');

            let points = [];

            // PrioritÃ© 1: Track points (pour les traces GPS)
            if (trkpts.length > 0) {
                addLog('ğŸ¯ Utilisation des track points (trkpt)', 'success');
                for (let i = 0; i < trkpts.length; i++) {
                    const pt = trkpts[i];
                    const lat = parseFloat(pt.getAttribute('lat'));
                    const lon = parseFloat(pt.getAttribute('lon'));

                    if (!isNaN(lat) && !isNaN(lon)) {
                        points.push({ lat, lon, index: i });
                    }
                }
            }
            // PrioritÃ© 2: Route points (itinÃ©raires calculÃ©s)
            else if (rtepts.length > 0) {
                addLog('ğŸ¯ Utilisation des route points (rtept)', 'success');
                for (let i = 0; i < rtepts.length; i++) {
                    const pt = rtepts[i];
                    const lat = parseFloat(pt.getAttribute('lat'));
                    const lon = parseFloat(pt.getAttribute('lon'));

                    if (!isNaN(lat) && !isNaN(lon)) {
                        points.push({ lat, lon, index: i });
                    }
                }
            }
            // PrioritÃ© 3: Waypoints (points d'intÃ©rÃªt)
            else if (wpts.length > 0) {
                addLog('ğŸ¯ Utilisation des waypoints (wpt)', 'success');
                for (let i = 0; i < wpts.length; i++) {
                    const pt = wpts[i];
                    const lat = parseFloat(pt.getAttribute('lat'));
                    const lon = parseFloat(pt.getAttribute('lon'));

                    if (!isNaN(lat) && !isNaN(lon)) {
                        points.push({ lat, lon, index: i });
                    }
                }
            }

            if (points.length === 0) {
                addLog('âŒ Aucun point valide trouvÃ© dans le fichier GPX', 'error');
                return null;
            }

            addLog(`âœ… ${points.length} points extraits avec succÃ¨s`, 'success');

            // Calculer la distance totale
            let totalDistance = 0;
            for (let i = 1; i < points.length; i++) {
                const dist = haversine(
                    points[i-1].lat, points[i-1].lon,
                    points[i].lat, points[i].lon
                );
                totalDistance += dist;
            }

            const distKm = (totalDistance / 1000).toFixed(2);
            addLog(`ğŸ“ Distance totale calculÃ©e: ${distKm} km`, 'success');

            return {
                points: points,
                distance: distKm,
                firstPoint: points[0],
                lastPoint: points[points.length - 1]
            };
        }

        document.getElementById('gpxFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            addLog(`ğŸ“‚ Fichier sÃ©lectionnÃ©: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'info');

            const reader = new FileReader();

            reader.onload = function(event) {
                addLog('ğŸ“– Lecture du fichier terminÃ©e', 'success');
                const xmlText = event.target.result;
                addLog(`ğŸ“„ Taille du contenu: ${xmlText.length} caractÃ¨res`, 'info');

                const result = parseGPXFile(xmlText);

                if (result) {
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = `
                        <h3>âœ… GPX chargÃ© avec succÃ¨s!</h3>
                        <p><strong>Points:</strong> ${result.points.length}</p>
                        <p><strong>Distance:</strong> ${result.distance} km</p>
                        <p><strong>Premier point:</strong> ${result.firstPoint.lat.toFixed(6)}, ${result.firstPoint.lon.toFixed(6)}</p>
                        <p><strong>Dernier point:</strong> ${result.lastPoint.lat.toFixed(6)}, ${result.lastPoint.lon.toFixed(6)}</p>
                        <hr>
                        <p style="font-size: 12px; color: #0f0;">
                            âœ… Ton fichier GPX est bien formÃ© et peut Ãªtre utilisÃ©!<br>
                            Tu peux maintenant l'intÃ©grer dans l'application radar.
                        </p>
                    `;
                    addLog('ğŸ‰ SUCCÃˆS: GPX prÃªt Ã  l'emploi', 'success');
                } else {
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = `
                        <h3>âŒ Erreur de chargement</h3>
                        <p style="color: #f00;">Le fichier GPX n'a pas pu Ãªtre parsÃ© correctement.</p>
                        <p>Consulte le journal de debug ci-dessus pour plus de dÃ©tails.</p>
                    `;
                    addLog('âŒ Ã‰CHEC: Impossible de parser le GPX', 'error');
                }
            };

            reader.onerror = function() {
                addLog('âŒ Erreur lors de la lecture du fichier', 'error');
            };

            reader.readAsText(file);
        });

        addLog('ğŸš€ Application de debug chargÃ©e', 'success');
        addLog('ğŸ‘‰ SÃ©lectionne un fichier GPX pour commencer', 'info');
    </script>
</body>
</html>

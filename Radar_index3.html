<!DOCTYPE html><html lang="fr"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Testeur Radar - Multi API</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #000; 
      color: #fff; 
      font-family: Arial, sans-serif; 
      overflow: hidden;
      height: 100vh;
    }

    #top-controls {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      z-index: 1000;
    }

    #status-btn {
      padding: 10px 15px;
      border: 2px solid #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .status-green { background: #0a0; color: #fff; }
    .status-orange { background: #f80; color: #000; }
    .status-red { background: #f00; color: #fff; }

    #settings-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #0ff;
      border-radius: 50%;
      background: #222;
      color: #0ff;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #settings-btn:active {
      background: #0ff;
      color: #000;
    }

    #speed-display {
      text-align: center;
      font-size: 180px;
      font-weight: bold;
      margin-top: 120px;
      text-shadow: 0 0 20px currentColor;
    }
    #speed-unit { font-size: 50px; vertical-align: super; margin-left: 5px; }

    #radar-panel {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      border: 3px solid #fff;
      border-radius: 15px;
      padding: 20px;
      min-width: 300px;
      text-align: center;
      display: none;
    }
    #radar-limit {
      font-size: 60px;
      font-weight: bold;
      color: #f00;
    }
    #radar-distance {
      font-size: 24px;
      margin-top: 10px;
    }

    #gauge-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      height: 40px;
      background: #222;
      border: 2px solid #fff;
      border-radius: 5px;
      overflow: hidden;
    }
    #gauge-fill {
      height: 100%;
      background: linear-gradient(90deg, #0f0, #ff0, #f00);
      width: 0%;
      transition: width 0.3s;
    }

    .bg-green { background: #0a0 !important; }
    .bg-orange { background: #f80 !important; }
    .bg-red { background: #f00 !important; }

    #modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1999;
      display: none;
    }

    #settings-modal {
      position: fixed;
      top: 5%;
      left: 5%;
      right: 5%;
      bottom: 5%;
      background: #111;
      border: 3px solid #0ff;
      padding: 15px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #settings-modal h3 {
      margin-bottom: 15px;
      color: #0ff;
      font-size: 20px;
      border-bottom: 2px solid #0ff;
      padding-bottom: 10px;
    }
    #settings-modal h4 {
      margin: 15px 0 8px 0;
      color: #ff0;
      font-size: 16px;
    }
    #settings-modal label {
      display: block;
      color: #aaa;
      font-size: 13px;
      margin-bottom: 5px;
    }
    #settings-modal input[type="text"],
    #settings-modal input[type="number"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      background: #222;
      border: 2px solid #fff;
      color: #fff;
      font-size: 16px;
      border-radius: 5px;
    }
    #settings-modal select {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      background: #222;
      border: 2px solid #fff;
      color: #fff;
      font-size: 16px;
      border-radius: 5px;
    }
    #settings-modal button {
      width: 100%;
      padding: 14px;
      border: none;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      margin: 5px 0;
      font-weight: bold;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #222;
      border: 2px solid #fff;
      border-radius: 5px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .checkbox-container label {
      margin: 0;
      cursor: pointer;
      font-size: 14px;
      color: #fff;
    }

    .radius-group {
      margin-left: 20px;
      padding: 10px;
      background: #1a1a1a;
      border-left: 3px solid #0ff;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .radius-group.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    #btn-validate {
      background: #0a0;
    }
    #btn-clear-key {
      background: #f80;
    }
    #btn-close {
      background: #666;
    }

    .info-box {
      background: #222;
      border-left: 4px solid #0ff;
      padding: 10px;
      margin: 10px 0;
      font-size: 13px;
      line-height: 1.5;
    }
    .info-box.warning {
      border-left-color: #ff0;
    }
    .info-box.success {
      border-left-color: #0f0;
    }
    .info-box.danger {
      border-left-color: #f00;
    }

    #debug-section {
      margin-top: 20px;
      border-top: 2px solid #0ff;
      padding-top: 15px;
    }
    #debug-section h4 {
      color: #0ff;
      margin-bottom: 10px;
      font-size: 16px;
    }
    #debug-log {
      background: #000;
      border: 2px solid #0f0;
      border-radius: 5px;
      padding: 10px;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      font-family: monospace;
      font-size: 12px;
      text-align: left;
      line-height: 1.5;
    }
    .log-entry {
      margin: 3px 0;
      padding: 3px 0;
      border-bottom: 1px solid #222;
    }
    .log-info { color: #0ff; }
    .log-success { color: #0f0; }
    .log-warning { color: #ff0; }
    .log-error { color: #f00; }
    .log-time { color: #888; font-size: 10px; margin-right: 5px; }
  </style>
</head>
<body class="">

  <div id="modal-overlay"></div>

  <div id="settings-modal">
    <h3>âš™ï¸ ParamÃ¨tres - Version Test Multi-API</h3>

    <h4>ğŸ”Œ Source API</h4>
    <select id="api-source">
      <option value="lufop" selected>Lufop API (officielle, gratuite)</option>
      <option value="blitzer">Blitzer.de (non officielle âš ï¸)</option>
    </select>

    <div class="info-box danger" id="blitzer-warning" style="display:none">
      âš ï¸ <b>Blitzer.de API non officielle</b><br>
      â€¢ Pas de documentation publique<br>
      â€¢ Peut cesser de fonctionner Ã  tout moment<br>
      â€¢ Utilisation potentiellement interdite par leurs CGU<br>
      â€¢ Format de donnÃ©es diffÃ©rent de Lufop
    </div>

    <h4>ğŸ”‘ ClÃ© API (uniquement pour Lufop)</h4>
    <label>Obtiens ta clÃ© gratuite sur <a href="https://api.lufop.net" target="_blank" style="color:#0ff">api.lufop.net</a></label>
    <input type="text" id="api-key-input" placeholder="Colle ta clÃ© API ici (32 caractÃ¨res)">

    <h4>ğŸŒ MÃ©thode d'accÃ¨s</h4>
    <select id="access-method">
      <option value="proxy" selected>Via Proxy (AllOrigins - contourne CORS)</option>
      <option value="direct">AccÃ¨s direct (peut Ã©chouer si CORS bloquÃ©)</option>
    </select>

    <div class="info-box">
      ğŸ’¡ <b>Proxy vs Direct :</b><br>
      â€¢ <b>Proxy</b> : Passe par AllOrigins pour contourner les restrictions CORS (recommandÃ©)<br>
      â€¢ <b>Direct</b> : Appel direct Ã  l'API (plus rapide mais peut Ãªtre bloquÃ© par le navigateur)
    </div>

    <h4>ğŸŒ Zone gÃ©ographique (options cumulables)</h4>

    <div class="checkbox-container" onclick="document.getElementById('limit-france').click()">
      <input type="checkbox" id="limit-france" checked onclick="event.stopPropagation()">
      <label for="limit-france">Limiter Ã  la France uniquement</label>
    </div>

    <div class="checkbox-container" onclick="document.getElementById('use-radius').click()">
      <input type="checkbox" id="use-radius" onclick="event.stopPropagation(); toggleRadius()">
      <label for="use-radius">Limiter par rayon autour de ma position</label>
    </div>

    <div class="radius-group disabled" id="radius-group">
      <label>Rayon en kilomÃ¨tres (10 Ã  5000)</label>
      <input type="number" id="radius-km" placeholder="1000" min="10" max="5000" value="1000">
    </div>

    <h4>ğŸ“Š Nombre maximum de radars</h4>
    <label>Saisis le nombre de radars Ã  charger (100 Ã  25000, <b style="color:#0f0">recommandÃ©: 5000</b>)</label>
    <input type="number" id="radar-count" placeholder="5000" min="100" max="25000" value="5000">

    <button id="btn-validate" onclick="saveSettings()">âœ“ VALIDER ET CHARGER</button>
    <button id="btn-clear-key" onclick="clearApiKey()">ğŸ—‘ï¸ EFFACER CACHE</button>
    <button id="btn-close" onclick="closeModal()">âœ• FERMER</button>

    <div id="debug-section">
      <h4>ğŸ“‹ Journal de dÃ©bogage</h4>
      <div id="debug-log">
        <div class="log-entry log-info"><span class="log-time">--:--:--</span> â„¹ï¸ Modale de paramÃ¨tres ouverte</div>
      </div>
    </div>
  </div>

  <div id="top-controls">
    <div id="status-btn" class="status-red" onclick="updateRadars()">Pas de base</div>
    <div id="settings-btn" onclick="openModal()" title="ParamÃ¨tres">?</div>
  </div>

  <div id="speed-display">
    <span id="speed-value">0</span><span id="speed-unit">km/h</span>
  </div>

  <div id="radar-panel" style="display: none;">
    <div id="radar-limit">50</div>
    <div id="radar-distance">Distance: 250m</div>
  </div>

  <div id="gauge-container">
    <div id="gauge-fill" style="width: 0%;"></div>
  </div>

  <script>
    let radars = [];
    let currentPos = null;
    let currentSpeed = 0;
    let currentBearing = 0;
    let activeRadar = null;
    let lastBeepTime = 0;
    let audioContext = null;

    function toggleRadius() {
      const checkbox = document.getElementById('use-radius');
      const radiusGroup = document.getElementById('radius-group');

      if (checkbox.checked) {
        radiusGroup.classList.remove('disabled');
        addLog('Mode rayon activÃ©', 'info');
      } else {
        radiusGroup.classList.add('disabled');
        addLog('Mode rayon dÃ©sactivÃ©', 'info');
      }
    }

    function addLog(msg, type = 'info') {
      console.log(`[${type}]`, msg);
      const log = document.getElementById('debug-log');
      if (!log) return;

      const time = new Date().toLocaleTimeString('fr-FR');
      const logClass = `log-${type}`;
      const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';

      const entry = document.createElement('div');
      entry.className = `log-entry ${logClass}`;
      entry.innerHTML = `<span class="log-time">${time}</span>${icon} ${msg}`;

      log.insertBefore(entry, log.firstChild);

      while (log.children.length > 50) {
        log.removeChild(log.lastChild);
      }
    }

    function closeModal() {
      document.getElementById('settings-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }

    function openModal() {
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('settings-modal').style.display = 'block';

      const apiSource = localStorage.getItem('api_source') || 'lufop';
      document.getElementById('api-source').value = apiSource;

      const accessMethod = localStorage.getItem('access_method') || 'proxy';
      document.getElementById('access-method').value = accessMethod;

      const currentKey = localStorage.getItem('lufop_api_key');
      if (currentKey) {
        document.getElementById('api-key-input').value = currentKey;
      }

      const radarCount = localStorage.getItem('radar_count') || '5000';
      document.getElementById('radar-count').value = radarCount;

      const limitFrance = localStorage.getItem('limit_france') !== 'false';
      document.getElementById('limit-france').checked = limitFrance;

      const useRadius = localStorage.getItem('use_radius') === 'true';
      document.getElementById('use-radius').checked = useRadius;

      const radiusKm = localStorage.getItem('radius_km') || '1000';
      document.getElementById('radius-km').value = radiusKm;

      if (useRadius) {
        document.getElementById('radius-group').classList.remove('disabled');
      }

      updateBlitzerWarning();
    }

    function updateBlitzerWarning() {
      const apiSource = document.getElementById('api-source').value;
      const warning = document.getElementById('blitzer-warning');
      warning.style.display = apiSource === 'blitzer' ? 'block' : 'none';
    }

    document.getElementById('api-source').addEventListener('change', updateBlitzerWarning);

    function clearApiKey() {
      if (confirm('Effacer le cache ?')) {
        localStorage.removeItem('radars_cache');
        localStorage.removeItem('radars_date');
        radars = [];
        updateStatusButton();
        addLog('âœ… Cache effacÃ©', 'success');
        alert('âœ… Cache effacÃ©');
      }
    }

    function initAudio() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    function beep(freq = 1000, duration = 200) {
      try {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = freq;
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        oscillator.start();
        setTimeout(() => oscillator.stop(), duration);
      } catch(e) {}
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function bearing(lat1, lon1, lat2, lon2) {
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(Î”Î») * Math.cos(Ï†2);
      const x = Math.cos(Ï†1) * Math.sin(Ï†2) -
                Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
      const Î¸ = Math.atan2(y, x);
      return (Î¸ * 180 / Math.PI + 360) % 360;
    }

    function isRelevantRadar(radar) {
      if (!currentPos) return false;
      const dist = haversine(currentPos.latitude, currentPos.longitude, 
                             radar.lat, radar.lon);
      if (dist > 1000) return false;

      const bear = bearing(currentPos.latitude, currentPos.longitude,
                           radar.lat, radar.lon);
      const azimut = parseFloat(radar.azimut || 0);
      const diffAzimut = Math.min(Math.abs(bear - azimut), 
                                   360 - Math.abs(bear - azimut));

      if (diffAzimut > 45) return false;
      if (radar.flash !== 'F' && radar.flash !== 'D') return false;
      if (radar.position === 'L') return false;

      return true;
    }

    async function updateRadars() {
      const apiSource = localStorage.getItem('api_source') || 'lufop';
      const accessMethod = localStorage.getItem('access_method') || 'proxy';

      addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      addLog('ğŸš€ CHARGEMENT RADARS', 'info');
      addLog('API: ' + apiSource.toUpperCase(), 'info');
      addLog('MÃ©thode: ' + (accessMethod === 'proxy' ? 'Proxy' : 'Direct'), 'info');

      if (apiSource === 'lufop') {
        await updateRadarsLufop();
      } else {
        await updateRadarsBlitzer();
      }
    }

    async function updateRadarsLufop() {
      const apiKey = localStorage.getItem('lufop_api_key');
      if (!apiKey) {
        addLog('âš ï¸ Aucune clÃ© API configurÃ©e', 'warning');
        alert('âš ï¸ Configure ta clÃ© API d\'abord (clique sur le bouton ?)');
        openModal();
        return;
      }

      const radarCount = localStorage.getItem('radar_count') || '5000';
      const limitFrance = localStorage.getItem('limit_france') !== 'false';
      const useRadius = localStorage.getItem('use_radius') === 'true';
      const radiusKm = localStorage.getItem('radius_km') || '1000';
      const accessMethod = localStorage.getItem('access_method') || 'proxy';

      let apiUrl = `https://api.lufop.net/api?key=${apiKey}&format=json&nbr=${radarCount}`;
      let modeDescription = '';

      if (limitFrance && useRadius) {
        if (!currentPos) {
          addLog('âŒ Position GPS non disponible', 'error');
          alert('âŒ Position GPS requise pour le mode rayon.');
          return;
        }
        apiUrl += `&pays=fr&q=${currentPos.latitude},${currentPos.longitude}&m=${radiusKm}`;
        modeDescription = `ğŸ‡«ğŸ‡· France + ğŸ“ Rayon ${radiusKm}km`;
        addLog('Mode: France + rayon ' + radiusKm + ' km', 'info');

      } else if (useRadius) {
        if (!currentPos) {
          addLog('âŒ Position GPS non disponible', 'error');
          alert('âŒ Position GPS requise pour le mode rayon.');
          return;
        }
        apiUrl += `&q=${currentPos.latitude},${currentPos.longitude}&m=${radiusKm}`;
        modeDescription = `ğŸŒ Monde + ğŸ“ Rayon ${radiusKm}km`;
        addLog('Mode: Rayon ' + radiusKm + ' km (tous pays)', 'info');

      } else if (limitFrance) {
        apiUrl += '&pays=fr';
        modeDescription = 'ğŸ‡«ğŸ‡· France uniquement';
        addLog('Mode: France uniquement', 'info');

      } else {
        modeDescription = 'ğŸŒ Monde entier';
        addLog('Mode: Monde entier', 'info');
      }

      const url = accessMethod === 'proxy' 
        ? `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`
        : apiUrl;

      if (currentPos) {
        addLog(`Position: ${currentPos.latitude.toFixed(4)}, ${currentPos.longitude.toFixed(4)}`, 'info');
      }
      addLog('URL: ' + apiUrl, 'info');

      try {
        addLog('ğŸ“¡ Envoi requÃªte...', 'info');

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 45000);

        const response = await fetch(url, {
          method: 'GET',
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        addLog('âœ… RÃ©ponse reÃ§ue!', 'success');
        addLog('Status: ' + response.status, 'success');

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const text = await response.text();
        addLog('Taille: ' + Math.round(text.length / 1024) + ' Ko', 'info');

        const data = JSON.parse(text);
        addLog('âœ… JSON valide', 'success');
        addLog('ğŸ“Š Radars reÃ§us: ' + data.length, 'success');

        radars = data.map(r => ({
          lat: parseFloat(r.latitude),
          lon: parseFloat(r.longitude),
          speed: parseInt(r.vitesse || 50),
          flash: r.flash || 'D',
          position: r.position || 'C',
          azimut: parseFloat(r.azimut || 0)
        }));

        localStorage.setItem('radars_cache', JSON.stringify(radars));
        localStorage.setItem('radars_date', new Date().toISOString());
        updateStatusButton();

        addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
        addLog('ğŸ‰ SUCCÃˆS! ' + radars.length + ' radars', 'success');
        addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');

        alert('âœ… ' + radars.length + ' radars chargÃ©s!\n' + modeDescription);

      } catch (e) {
        addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'error');
        addLog('ğŸ’¥ ERREUR: ' + e.message, 'error');
        addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'error');
        alert('âŒ Erreur: ' + e.message);
      }
    }

    async function updateRadarsBlitzer() {
      if (!currentPos) {
        addLog('âŒ Position GPS non disponible', 'error');
        alert('âŒ Blitzer.de nÃ©cessite ta position GPS');
        return;
      }

      const radarCount = localStorage.getItem('radar_count') || '5000';
      const radiusKm = localStorage.getItem('radius_km') || '1000';
      const useRadius = localStorage.getItem('use_radius') === 'true';
      const accessMethod = localStorage.getItem('access_method') || 'proxy';

      const radius = useRadius ? parseFloat(radiusKm) : 1000;
      const radiusDeg = radius / 111; // approximation 1Â° â‰ˆ 111 km

      const lat = currentPos.latitude;
      const lon = currentPos.longitude;
      const box = `${lat-radiusDeg},${lon-radiusDeg},${lat+radiusDeg},${lon+radiusDeg}`;

      const apiUrl = `https://cdn2.atudo.net/api/4.0/pois.php?z=5&type=0,1,2,3,4,5,6,101,102,103&box=${box}`;

      const url = accessMethod === 'proxy' 
        ? `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`
        : apiUrl;

      addLog('Mode: Blitzer.de rayon ' + radius + ' km', 'warning');
      addLog(`Position: ${lat.toFixed(4)}, ${lon.toFixed(4)}`, 'info');
      addLog('Box: ' + box, 'info');

      try {
        addLog('ğŸ“¡ Envoi requÃªte Blitzer.de...', 'info');

        const response = await fetch(url);

        addLog('âœ… RÃ©ponse reÃ§ue!', 'success');
        addLog('Status: ' + response.status, 'success');

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const text = await response.text();
        addLog('Taille: ' + Math.round(text.length / 1024) + ' Ko', 'info');

        const data = JSON.parse(text);
        addLog('âœ… JSON valide', 'success');

        let poisArray = [];
        if (data.pois && typeof data.pois === 'object') {
          poisArray = Object.values(data.pois);
        } else if (Array.isArray(data)) {
          poisArray = data;
        }

        addLog('ğŸ“Š Radars reÃ§us: ' + poisArray.length, 'success');

        radars = poisArray.slice(0, parseInt(radarCount)).map(r => ({
          lat: parseFloat(r.lat || r.latitude || 0),
          lon: parseFloat(r.lng || r.lon || r.longitude || 0),
          speed: parseInt(r.speed || r.vmax || 50),
          flash: 'D',
          position: 'C',
          azimut: 0
        }));

        localStorage.setItem('radars_cache', JSON.stringify(radars));
        localStorage.setItem('radars_date', new Date().toISOString());
        updateStatusButton();

        addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
        addLog('ğŸ‰ SUCCÃˆS! ' + radars.length + ' radars', 'success');
        addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');

        alert('âœ… ' + radars.length + ' radars chargÃ©s (Blitzer.de)!');

      } catch (e) {
        addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'error');
        addLog('ğŸ’¥ ERREUR Blitzer: ' + e.message, 'error');
        addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'error');
        alert('âŒ Erreur Blitzer.de: ' + e.message);
      }
    }

    function updateStatusButton() {
      const lastUpdate = localStorage.getItem('radars_date');
      const btn = document.getElementById('status-btn');

      if (!lastUpdate) {
        btn.className = 'status-red';
        btn.textContent = 'Pas de base';
        return;
      }

      const daysDiff = (Date.now() - new Date(lastUpdate)) / (1000 * 60 * 60 * 24);
      if (daysDiff < 1) {
        btn.className = 'status-green';
        btn.textContent = 'Ã€ jour';
      } else if (daysDiff < 30) {
        btn.className = 'status-orange';
        btn.textContent = `MAJ: ${Math.floor(daysDiff)}j`;
      } else {
        btn.className = 'status-red';
        btn.textContent = `MAJ: ${Math.floor(daysDiff)}j`;
      }
    }

    function saveSettings() {
      const apiSource = document.getElementById('api-source').value;
      const accessMethod = document.getElementById('access-method').value;
      const key = document.getElementById('api-key-input').value.trim();
      const radarCount = document.getElementById('radar-count').value;
      const limitFrance = document.getElementById('limit-france').checked;
      const useRadius = document.getElementById('use-radius').checked;
      const radiusKm = document.getElementById('radius-km').value;

      if (apiSource === 'lufop' && !key) {
        addLog('âŒ ClÃ© API requise pour Lufop!', 'error');
        alert('âŒ Entre une clÃ© API Lufop valide');
        return;
      }

      if (!radarCount || radarCount < 100 || radarCount > 25000) {
        addLog('âŒ Nombre invalide!', 'error');
        alert('âŒ Entre un nombre entre 100 et 25000');
        return;
      }

      addLog('ğŸ’¾ Enregistrement paramÃ¨tres...', 'info');
      addLog('API: ' + apiSource, 'info');
      addLog('MÃ©thode: ' + accessMethod, 'info');
      addLog('Radars max: ' + radarCount, 'info');
      addLog('France: ' + (limitFrance ? 'Oui' : 'Non'), 'info');
      addLog('Rayon: ' + (useRadius ? radiusKm + ' km' : 'Non'), 'info');

      localStorage.setItem('api_source', apiSource);
      localStorage.setItem('access_method', accessMethod);
      localStorage.setItem('lufop_api_key', key);
      localStorage.setItem('radar_count', radarCount);
      localStorage.setItem('limit_france', limitFrance);
      localStorage.setItem('use_radius', useRadius);
      localStorage.setItem('radius_km', radiusKm);

      addLog('âœ… ParamÃ¨tres sauvegardÃ©s', 'success');

      updateRadars();
    }

    navigator.geolocation.watchPosition(pos => {
      currentPos = pos.coords;
      currentSpeed = (pos.coords.speed || 0) * 3.6;
      currentBearing = pos.coords.heading || 0;

      document.getElementById('speed-value').textContent = Math.round(currentSpeed);

      const relevant = radars.filter(isRelevantRadar)
        .map(r => ({
          ...r,
          distance: haversine(currentPos.latitude, currentPos.longitude, r.lat, r.lon)
        }))
        .sort((a, b) => a.distance - b.distance);

      if (relevant.length > 0 && relevant[0].distance < 500) {
        const radar = relevant[0];
        activeRadar = radar;

        document.getElementById('radar-panel').style.display = 'block';
        document.getElementById('radar-limit').textContent = radar.speed;
        document.getElementById('radar-distance').textContent = `${Math.round(radar.distance)}m`;

        if (currentSpeed <= radar.speed + 1) {
          document.body.className = 'bg-green';
        } else if (currentSpeed <= radar.speed + 4) {
          document.body.className = 'bg-orange';
        } else {
          document.body.className = 'bg-red';
        }

        const now = Date.now();
        if (radar.distance < 500 && lastBeepTime === 0) {
          beep(1500, 300);
          lastBeepTime = now;
        }
        if (currentSpeed > radar.speed + 4 && now - lastBeepTime > 2000) {
          beep(2000, 200);
          lastBeepTime = now;
        }

        const gaugeProgress = Math.max(0, Math.min(100, ((500 - radar.distance) / 550) * 100));
        document.getElementById('gauge-fill').style.width = gaugeProgress + '%';

      } else {
        activeRadar = null;
        document.getElementById('radar-panel').style.display = 'none';
        document.body.className = '';
        document.getElementById('gauge-fill').style.width = '0%';
        lastBeepTime = 0;
      }
    }, null, { enableHighAccuracy: true, maximumAge: 1000 });

    window.onload = () => {
      addLog('ğŸš€ App Multi-API dÃ©marrÃ©e', 'success');
      const cached = localStorage.getItem('radars_cache');
      if (cached) {
        try {
          radars = JSON.parse(cached);
          addLog('ğŸ“¦ ' + radars.length + ' radars en cache', 'success');
        } catch(e) {
          addLog('âŒ Cache corrompu', 'error');
        }
      }
      updateStatusButton();

      const apiSource = localStorage.getItem('api_source') || 'lufop';
      addLog('API configurÃ©e: ' + apiSource.toUpperCase(), 'info');
    };
  </script>

</body></html>
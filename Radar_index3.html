<!DOCTYPE html><html lang="fr"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Testeur Radar - Multi API + Zoom</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; color: #fff; font-family: Arial, sans-serif; overflow: hidden; height: 100vh; }
    #top-controls { position: fixed; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000; }
    #status-btn { padding: 10px 15px; border: 2px solid #fff; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .status-green { background: #0a0; color: #fff; }
    .status-orange { background: #f80; color: #000; }
    .status-red { background: #f00; color: #fff; }
    #settings-btn { width: 40px; height: 40px; border: 2px solid #0ff; border-radius: 50%; background: #222; color: #0ff; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #settings-btn:active { background: #0ff; color: #000; }
    #speed-display { text-align: center; font-size: 180px; font-weight: bold; margin-top: 120px; text-shadow: 0 0 20px currentColor; }
    #speed-unit { font-size: 50px; vertical-align: super; margin-left: 5px; }
    #radar-panel { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 3px solid #fff; border-radius: 15px; padding: 20px; min-width: 300px; text-align: center; display: none; }
    #radar-limit { font-size: 60px; font-weight: bold; color: #f00; }
    #radar-distance { font-size: 24px; margin-top: 10px; }
    #gauge-container { position: fixed; bottom: 10px; left: 10px; right: 10px; height: 40px; background: #222; border: 2px solid #fff; border-radius: 5px; overflow: hidden; }
    #gauge-fill { height: 100%; background: linear-gradient(90deg, #0f0, #ff0, #f00); width: 0%; transition: width 0.3s; }
    .bg-green { background: #0a0 !important; }
    .bg-orange { background: #f80 !important; }
    .bg-red { background: #f00 !important; }
    #modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1999; display: none; }
    #settings-modal { position: fixed; top: 5%; left: 5%; right: 5%; bottom: 5%; background: #111; border: 3px solid #0ff; padding: 15px; border-radius: 10px; z-index: 2000; display: none; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    #settings-modal h3 { margin-bottom: 15px; color: #0ff; font-size: 20px; border-bottom: 2px solid #0ff; padding-bottom: 10px; }
    #settings-modal h4 { margin: 15px 0 8px 0; color: #ff0; font-size: 16px; }
    #settings-modal label { display: block; color: #aaa; font-size: 13px; margin-bottom: 5px; }
    #settings-modal input[type="text"], #settings-modal input[type="number"] { width: 100%; padding: 12px; margin-bottom: 10px; background: #222; border: 2px solid #fff; color: #fff; font-size: 16px; border-radius: 5px; }
    #settings-modal select { width: 100%; padding: 12px; margin-bottom: 10px; background: #222; border: 2px solid #fff; color: #fff; font-size: 16px; border-radius: 5px; }
    #settings-modal button { width: 100%; padding: 14px; border: none; color: #fff; font-size: 16px; cursor: pointer; border-radius: 5px; margin: 5px 0; font-weight: bold; }
    .checkbox-container { display: flex; align-items: center; gap: 10px; padding: 12px; background: #222; border: 2px solid #fff; border-radius: 5px; margin-bottom: 10px; cursor: pointer; }
    .checkbox-container input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
    .checkbox-container label { margin: 0; cursor: pointer; font-size: 14px; color: #fff; }
    .radius-group { margin-left: 20px; padding: 10px; background: #1a1a1a; border-left: 3px solid #0ff; border-radius: 5px; margin-bottom: 10px; }
    .radius-group.disabled { opacity: 0.5; pointer-events: none; }
    #btn-validate { background: #0a0; }
    #btn-clear-key { background: #f80; }
    #btn-close { background: #666; }
    .info-box { background: #222; border-left: 4px solid #0ff; padding: 10px; margin: 10px 0; font-size: 13px; line-height: 1.5; }
    .info-box.warning { border-left-color: #ff0; }
    .info-box.success { border-left-color: #0f0; }
    .info-box.danger { border-left-color: #f00; }
    #debug-section { margin-top: 20px; border-top: 2px solid #0ff; padding-top: 15px; }
    #debug-section h4 { color: #0ff; margin-bottom: 10px; font-size: 16px; }
    #debug-log { background: #000; border: 2px solid #0f0; border-radius: 5px; padding: 10px; min-height: 200px; max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; font-family: monospace; font-size: 12px; text-align: left; line-height: 1.5; }
    .log-entry { margin: 3px 0; padding: 3px 0; border-bottom: 1px solid #222; }
    .log-info { color: #0ff; }
    .log-success { color: #0f0; }
    .log-warning { color: #ff0; }
    .log-error { color: #f00; }
    .log-time { color: #888; font-size: 10px; margin-right: 5px; }
  </style>
</head>
<body>

  <div id="modal-overlay"></div>

  <div id="settings-modal">
    <h3>‚öôÔ∏è Param√®tres Multi-API + Zoom</h3>

    <h4>üîå Source API</h4>
    <select id="api-source">
      <option value="lufop" selected>Lufop API (officielle)</option>
      <option value="blitzer">Blitzer.de (non officielle ‚ö†Ô∏è)</option>
    </select>

    <div class="info-box danger" id="blitzer-warning" style="display:none">
      ‚ö†Ô∏è <b>Blitzer.de non officielle - peut cesser de fonctionner</b>
    </div>

    <h4>üîë Cl√© API (Lufop uniquement)</h4>
    <input type="text" id="api-key-input" placeholder="Cl√© API Lufop">

    <h4>üåê M√©thode d'acc√®s</h4>
    <select id="access-method">
      <option value="proxy" selected>Via Proxy (recommand√©)</option>
      <option value="direct">Direct</option>
    </select>

    <h4>üåç Zone g√©ographique</h4>

    <div class="checkbox-container" onclick="document.getElementById('limit-france').click()">
      <input type="checkbox" id="limit-france" checked onclick="event.stopPropagation()">
      <label for="limit-france">Limiter √† la France</label>
    </div>

    <div class="checkbox-container" onclick="document.getElementById('use-radius').click()">
      <input type="checkbox" id="use-radius" onclick="event.stopPropagation(); toggleRadius()">
      <label for="use-radius">Limiter par rayon</label>
    </div>

    <div class="radius-group disabled" id="radius-group">
      <label>Rayon en km (10-5000)</label>
      <input type="number" id="radius-km" placeholder="1000" min="10" max="5000" value="1000">
    </div>

    <h4>üîç Zoom Blitzer.de (1=large, 15=d√©taill√©)</h4>
    <label><b style="color:#0f0">Zoom 1</b> (continent, peu de radars) ‚Üí <b style="color:#0f0">15</b> (local, max radars)</label>
    <input type="number" id="zoom-level" placeholder="8" min="1" max="15" value="8">

    <div class="info-box warning">
      üîç <b>Param√®tre Blitzer.de uniquement</b><br>
      ‚Ä¢ Zoom 1-5: Vue large (peu de radars)<br>
      ‚Ä¢ Zoom 6-10: √âquilibr√© (<b>recommand√©: 8</b>)<br>
      ‚Ä¢ Zoom 11-15: D√©taill√© (max radars, lent)
    </div>

    <h4>üìä Nombre max de radars</h4>
    <input type="number" id="radar-count" placeholder="5000" min="100" max="25000" value="5000">

    <button id="btn-validate" onclick="saveSettings()">‚úì VALIDER ET CHARGER</button>
    <button id="btn-clear-key" onclick="clearCache()">üóëÔ∏è EFFACER CACHE</button>
    <button id="btn-close" onclick="closeModal()">‚úï FERMER</button>

    <div id="debug-section">
      <h4>üìã Journal</h4>
      <div id="debug-log"></div>
    </div>
  </div>

  <div id="top-controls">
    <div id="status-btn" class="status-red" onclick="updateRadars()">Pas de base</div>
    <div id="settings-btn" onclick="openModal()">?</div>
  </div>

  <div id="speed-display">
    <span id="speed-value">0</span><span id="speed-unit">km/h</span>
  </div>

  <div id="radar-panel" style="display: none;">
    <div id="radar-limit">50</div>
    <div id="radar-distance">Distance: 250m</div>
  </div>

  <div id="gauge-container">
    <div id="gauge-fill"></div>
  </div>

  <script>
    let radars = [], currentPos = null, currentSpeed = 0, currentBearing = 0, activeRadar = null, lastBeepTime = 0, audioContext = null;

    function toggleRadius() {
      const checkbox = document.getElementById('use-radius');
      document.getElementById('radius-group').classList.toggle('disabled', !checkbox.checked);
      addLog('Mode rayon ' + (checkbox.checked ? 'activ√©' : 'd√©sactiv√©'), 'info');
    }

    function addLog(msg, type = 'info') {
      const log = document.getElementById('debug-log');
      if (!log) return;
      const time = new Date().toLocaleTimeString('fr-FR');
      const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      const entry = document.createElement('div');
      entry.className = 'log-entry log-' + type;
      entry.innerHTML = '<span class="log-time">' + time + '</span>' + icon + ' ' + msg;
      log.insertBefore(entry, log.firstChild);
      while (log.children.length > 50) log.removeChild(log.lastChild);
    }

    function closeModal() {
      document.getElementById('settings-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }

    function openModal() {
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('settings-modal').style.display = 'block';

      document.getElementById('api-source').value = localStorage.getItem('api_source') || 'lufop';
      document.getElementById('access-method').value = localStorage.getItem('access_method') || 'proxy';
      document.getElementById('api-key-input').value = localStorage.getItem('lufop_api_key') || '';
      document.getElementById('radar-count').value = localStorage.getItem('radar_count') || '5000';
      document.getElementById('limit-france').checked = localStorage.getItem('limit_france') !== 'false';
      document.getElementById('use-radius').checked = localStorage.getItem('use_radius') === 'true';
      document.getElementById('radius-km').value = localStorage.getItem('radius_km') || '1000';
      document.getElementById('zoom-level').value = localStorage.getItem('zoom_level') || '8';

      if (document.getElementById('use-radius').checked) {
        document.getElementById('radius-group').classList.remove('disabled');
      }

      document.getElementById('blitzer-warning').style.display = 
        document.getElementById('api-source').value === 'blitzer' ? 'block' : 'none';
    }

    document.getElementById('api-source').addEventListener('change', () => {
      document.getElementById('blitzer-warning').style.display = 
        document.getElementById('api-source').value === 'blitzer' ? 'block' : 'none';
    });

    function clearCache() {
      if (confirm('Effacer le cache ?')) {
        localStorage.removeItem('radars_cache');
        localStorage.removeItem('radars_date');
        radars = [];
        updateStatusButton();
        addLog('‚úÖ Cache effac√©', 'success');
        alert('‚úÖ Cache effac√©');
      }
    }

    function initAudio() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    function beep(freq = 1000, duration = 200) {
      try {
        initAudio();
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, audioContext.currentTime);
        osc.start();
        setTimeout(() => osc.stop(), duration);
      } catch(e) {}
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180, œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180, ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function bearing(lat1, lon1, lat2, lon2) {
      const œÜ1 = lat1 * Math.PI / 180, œÜ2 = lat2 * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const Œ∏ = Math.atan2(Math.sin(ŒîŒª) * Math.cos(œÜ2), Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª));
      return (Œ∏ * 180 / Math.PI + 360) % 360;
    }

    function isRelevantRadar(r) {
      if (!currentPos) return false;
      const dist = haversine(currentPos.latitude, currentPos.longitude, r.lat, r.lon);
      if (dist > 1000) return false;
      const bear = bearing(currentPos.latitude, currentPos.longitude, r.lat, r.lon);
      const azimut = parseFloat(r.azimut || 0);
      const diffAz = Math.min(Math.abs(bear - azimut), 360 - Math.abs(bear - azimut));
      return diffAz <= 45 && (r.flash === 'F' || r.flash === 'D') && r.position !== 'L';
    }

    async function updateRadars() {
      const apiSource = localStorage.getItem('api_source') || 'lufop';
      addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
      addLog('üöÄ CHARGEMENT ' + apiSource.toUpperCase(), 'info');

      if (apiSource === 'lufop') await updateLufop();
      else await updateBlitzer();
    }

    async function updateLufop() {
      const key = localStorage.getItem('lufop_api_key');
      if (!key) { alert('Cl√© API requise'); openModal(); return; }

      const nbr = localStorage.getItem('radar_count') || '5000';
      const fr = localStorage.getItem('limit_france') !== 'false';
      const useR = localStorage.getItem('use_radius') === 'true';
      const km = localStorage.getItem('radius_km') || '1000';
      const method = localStorage.getItem('access_method') || 'proxy';

      let url = 'https://api.lufop.net/api?key=' + key + '&format=json&nbr=' + nbr;

      if (fr && useR) {
        if (!currentPos) { alert('GPS requis'); return; }
        url += '&pays=fr&q=' + currentPos.latitude + ',' + currentPos.longitude + '&m=' + km;
      } else if (useR) {
        if (!currentPos) { alert('GPS requis'); return; }
        url += '&q=' + currentPos.latitude + ',' + currentPos.longitude + '&m=' + km;
      } else if (fr) {
        url += '&pays=fr';
      }

      const finalUrl = method === 'proxy' ? 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url) : url;

      try {
        addLog('üì° Requ√™te...', 'info');
        const r = await fetch(finalUrl);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        addLog('üìä Re√ßus: ' + data.length, 'success');
        radars = data.map(x => ({
          lat: parseFloat(x.latitude), lon: parseFloat(x.longitude),
          speed: parseInt(x.vitesse || 50), flash: x.flash || 'D',
          position: x.position || 'C', azimut: parseFloat(x.azimut || 0)
        }));
        localStorage.setItem('radars_cache', JSON.stringify(radars));
        localStorage.setItem('radars_date', new Date().toISOString());
        updateStatusButton();
        addLog('üéâ SUCC√àS! ' + radars.length + ' radars', 'success');
        alert('‚úÖ ' + radars.length + ' radars charg√©s!');
      } catch(e) {
        addLog('üí• ERREUR: ' + e.message, 'error');
        alert('‚ùå ' + e.message);
      }
    }

    async function updateBlitzer() {
      if (!currentPos) { alert('GPS requis'); return; }

      const km = parseFloat(localStorage.getItem('radius_km') || '1000');
      const zoom = parseInt(localStorage.getItem('zoom_level') || '8');
      const method = localStorage.getItem('access_method') || 'proxy';

      const deg = km / 111;
      const lat = currentPos.latitude, lon = currentPos.longitude;
      const latMin = Math.max(-90, lat - deg);
      const latMax = Math.min(90, lat + deg);
      const lonMin = Math.max(-180, lon - deg);
      const lonMax = Math.min(180, lon + deg);
      const box = latMin + ',' + lonMin + ',' + latMax + ',' + lonMax;

      const url = 'https://cdn2.atudo.net/api/4.0/pois.php?z=' + zoom + '&type=0,1,2,3,4,5,6,101,102,103&box=' + box;
      const finalUrl = method === 'proxy' ? 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url) : url;

      addLog('Rayon: ' + km + ' km, Zoom: ' + zoom, 'warning');
      addLog('Box: ' + box, 'info');

      try {
        addLog('üì° Blitzer...', 'info');
        const r = await fetch(finalUrl);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        const pois = data.pois ? Object.values(data.pois) : (Array.isArray(data) ? data : []);
        addLog('üìä Re√ßus: ' + pois.length, 'success');
        radars = pois.slice(0, parseInt(localStorage.getItem('radar_count') || '5000')).map(x => ({
          lat: parseFloat(x.lat || x.latitude || 0),
          lon: parseFloat(x.lng || x.lon || x.longitude || 0),
          speed: parseInt(x.speed || x.vmax || 50),
          flash: 'D', position: 'C', azimut: 0
        }));
        localStorage.setItem('radars_cache', JSON.stringify(radars));
        localStorage.setItem('radars_date', new Date().toISOString());
        updateStatusButton();
        addLog('üéâ SUCC√àS! ' + radars.length + ' radars', 'success');
        alert('‚úÖ ' + radars.length + ' radars (Blitzer)!');
      } catch(e) {
        addLog('üí• ERREUR: ' + e.message, 'error');
        alert('‚ùå ' + e.message);
      }
    }

    function updateStatusButton() {
      const date = localStorage.getItem('radars_date');
      const btn = document.getElementById('status-btn');
      if (!date) { btn.className = 'status-red'; btn.textContent = 'Pas de base'; return; }
      const days = (Date.now() - new Date(date)) / 86400000;
      if (days < 1) { btn.className = 'status-green'; btn.textContent = '√Ä jour'; }
      else if (days < 30) { btn.className = 'status-orange'; btn.textContent = 'MAJ: ' + Math.floor(days) + 'j'; }
      else { btn.className = 'status-red'; btn.textContent = 'MAJ: ' + Math.floor(days) + 'j'; }
    }

    function saveSettings() {
      const api = document.getElementById('api-source').value;
      const method = document.getElementById('access-method').value;
      const key = document.getElementById('api-key-input').value.trim();
      const nbr = document.getElementById('radar-count').value;
      const fr = document.getElementById('limit-france').checked;
      const useR = document.getElementById('use-radius').checked;
      const km = document.getElementById('radius-km').value;
      const zoom = document.getElementById('zoom-level').value;

      if (api === 'lufop' && !key) { alert('Cl√© requise'); return; }
      if (!nbr || nbr < 100 || nbr > 25000) { alert('Nombre invalide'); return; }

      addLog('üíæ Sauvegarde...', 'info');
      addLog('API: ' + api + ', Zoom: ' + zoom, 'info');

      localStorage.setItem('api_source', api);
      localStorage.setItem('access_method', method);
      localStorage.setItem('lufop_api_key', key);
      localStorage.setItem('radar_count', nbr);
      localStorage.setItem('limit_france', fr);
      localStorage.setItem('use_radius', useR);
      localStorage.setItem('radius_km', km);
      localStorage.setItem('zoom_level', zoom);

      addLog('‚úÖ Sauvegard√©', 'success');
      updateRadars();
    }

    navigator.geolocation.watchPosition(pos => {
      currentPos = pos.coords;
      currentSpeed = (pos.coords.speed || 0) * 3.6;
      currentBearing = pos.coords.heading || 0;

      document.getElementById('speed-value').textContent = Math.round(currentSpeed);

      const rel = radars.filter(isRelevantRadar).map(r => ({
        ...r, distance: haversine(currentPos.latitude, currentPos.longitude, r.lat, r.lon)
      })).sort((a, b) => a.distance - b.distance);

      if (rel.length > 0 && rel[0].distance < 500) {
        const radar = rel[0];
        activeRadar = radar;
        document.getElementById('radar-panel').style.display = 'block';
        document.getElementById('radar-limit').textContent = radar.speed;
        document.getElementById('radar-distance').textContent = Math.round(radar.distance) + 'm';

        if (currentSpeed <= radar.speed + 1) document.body.className = 'bg-green';
        else if (currentSpeed <= radar.speed + 4) document.body.className = 'bg-orange';
        else document.body.className = 'bg-red';

        const now = Date.now();
        if (radar.distance < 500 && lastBeepTime === 0) { beep(1500, 300); lastBeepTime = now; }
        if (currentSpeed > radar.speed + 4 && now - lastBeepTime > 2000) { beep(2000, 200); lastBeepTime = now; }

        document.getElementById('gauge-fill').style.width = Math.max(0, Math.min(100, ((500 - radar.distance) / 550) * 100)) + '%';
      } else {
        activeRadar = null;
        document.getElementById('radar-panel').style.display = 'none';
        document.body.className = '';
        document.getElementById('gauge-fill').style.width = '0%';
        lastBeepTime = 0;
      }
    }, null, { enableHighAccuracy: true, maximumAge: 1000 });

    window.onload = () => {
      addLog('üöÄ App Multi-API + Zoom d√©marr√©e', 'success');
      const cached = localStorage.getItem('radars_cache');
      if (cached) {
        try {
          radars = JSON.parse(cached);
          addLog('üì¶ ' + radars.length + ' en cache', 'success');
        } catch(e) {}
      }
      updateStatusButton();
    };
  </script>

</body></html>
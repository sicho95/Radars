<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Radar Alert - Corrig√©</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #000; 
      color: #fff; 
      font-family: Arial, sans-serif; 
      overflow: hidden;
      height: 100vh;
      transition: background 0.3s;
    }

    #top-controls {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      z-index: 1000;
    }

    #status-btn {
      padding: 10px 15px;
      border: 2px solid #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    .status-green { background: #0a0; color: #fff; }
    .status-orange { background: #f80; color: #000; }
    .status-red { background: #f00; color: #fff; }

    #settings-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #0ff;
      border-radius: 50%;
      background: #222;
      color: #0ff;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #settings-btn:active { background: #0ff; color: #000; }

    #speed-display {
      text-align: center;
      font-size: 180px;
      font-weight: bold;
      margin-top: 120px;
      text-shadow: 0 0 20px currentColor;
    }
    #speed-unit { font-size: 50px; vertical-align: super; margin-left: 5px; }

    #radar-panel {
      position: fixed;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.95);
      border: 4px solid #fff;
      border-radius: 20px;
      padding: 25px 30px;
      min-width: 320px;
      text-align: center;
      display: none;
      box-shadow: 0 0 30px rgba(255,255,255,0.5);
    }
    #radar-limit {
      font-size: 70px;
      font-weight: bold;
      color: #f00;
      text-shadow: 0 0 10px #f00;
    }
    #radar-distance {
      font-size: 28px;
      margin-top: 10px;
      font-weight: bold;
    }
    #radar-distance.passed {
      color: #888;
      font-style: italic;
    }

    #gauge-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      height: 60px;
      background: #222;
      border: 3px solid #fff;
      border-radius: 8px;
      overflow: visible;
      position: relative;
    }
    #gauge-fill {
      height: 100%;
      background: linear-gradient(90deg, #0f0, #ff0, #f00);
      width: 0%;
      transition: width 0.3s;
      border-radius: 5px;
    }

    /* Marqueur du radar sur la barre */
    #radar-marker {
      position: absolute;
      top: -5px;
      bottom: -5px;
      width: 4px;
      background: #fff;
      box-shadow: 0 0 10px #fff;
      display: none;
      z-index: 10;
    }
    #radar-marker::before {
      content: 'üì∑';
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
    }

    .bg-green { background: #0a0 !important; }
    .bg-orange { background: #f80 !important; }
    .bg-red { background: #f00 !important; }

    #modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1999;
      display: none;
    }

    #settings-modal {
      position: fixed;
      top: 5%; left: 5%; right: 5%; bottom: 5%;
      background: #111;
      border: 3px solid #0ff;
      padding: 20px;
      border-radius: 15px;
      z-index: 2000;
      display: none;
      overflow-y: auto;
    }

    #settings-modal h3 {
      color: #0ff;
      font-size: 24px;
      margin-bottom: 20px;
      border-bottom: 2px solid #0ff;
      padding-bottom: 10px;
    }

    #settings-modal h4 {
      color: #ff0;
      font-size: 18px;
      margin: 20px 0 10px 0;
    }

    #settings-modal label {
      display: block;
      color: #aaa;
      font-size: 14px;
      margin-bottom: 5px;
    }

    #settings-modal input[type="text"] {
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      background: #222;
      border: 2px solid #fff;
      color: #fff;
      font-size: 16px;
      border-radius: 8px;
    }

    #settings-modal button {
      width: 100%;
      padding: 15px;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
    }

    #btn-load { background: #0a0; }
    #btn-clear { background: #f80; }
    #btn-close { background: #666; }

    .info-box {
      background: #222;
      border-left: 4px solid #0ff;
      padding: 15px;
      margin: 15px 0;
      font-size: 14px;
      line-height: 1.6;
      border-radius: 5px;
    }
    .info-box.success { border-left-color: #0f0; }
    .info-box.warning { border-left-color: #ff0; }

    #debug-info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border: 2px solid #0ff;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      display: none;
      max-width: 300px;
    }

    #debug-toggle {
      position: fixed;
      bottom: 80px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: #222;
      border: 2px solid #0ff;
      border-radius: 50%;
      color: #0ff;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
  </style>
</head>
<body>

  <div id="modal-overlay"></div>

  <div id="settings-modal">
    <h3>‚öôÔ∏è Configuration Radar Alert</h3>

    <div class="info-box success">
      ‚úÖ <b>Algorithme corrig√© :</b><br>
      ‚Ä¢ D√©tection am√©lior√©e des radars par derri√®re<br>
      ‚Ä¢ Zones d'alerte variables selon vitesse<br>
      ‚Ä¢ Marqueur de position du radar sur la barre
    </div>

    <h4>üîë Cl√© API Lufop</h4>
    <label>Obtiens ta cl√© sur <a href="https://api.lufop.net" target="_blank" style="color:#0ff">api.lufop.net</a></label>
    <input type="text" id="api-key" placeholder="Cl√© API (32 caract√®res)">

    <div class="info-box warning">
      üìç <b>Zones d'alerte dynamiques :</b><br>
      ‚Ä¢ ‚â•130 km/h : 2000m avant / 100m apr√®s<br>
      ‚Ä¢ 110 km/h : 1500m avant / 80m apr√®s<br>
      ‚Ä¢ 90 km/h : 1000m avant / 70m apr√®s<br>
      ‚Ä¢ 70-89 km/h : 800m avant / 60m apr√®s<br>
      ‚Ä¢ <70 km/h : 500m avant / 50m apr√®s
    </div>

    <button id="btn-load" onclick="loadRadars()">‚úì CHARGER LES RADARS FRANCE</button>
    <button id="btn-clear" onclick="clearData()">üóëÔ∏è EFFACER CACHE</button>
    <button id="btn-close" onclick="closeModal()">‚úï FERMER</button>
  </div>

  <div id="top-controls">
    <div id="status-btn" class="status-red" onclick="loadRadars()">Aucune donn√©e</div>
    <div id="settings-btn" onclick="openModal()" title="Param√®tres">‚öô</div>
  </div>

  <div id="debug-toggle" onclick="toggleDebug()" title="Debug">üêõ</div>

  <div id="debug-info">
    <div>Heading: <span id="dbg-heading">--</span>¬∞</div>
    <div>Lat: <span id="dbg-lat">--</span></div>
    <div>Lon: <span id="dbg-lon">--</span></div>
    <div>Radars: <span id="dbg-radars">0</span></div>
    <div>Relevant: <span id="dbg-relevant">0</span></div>
  </div>

  <div id="speed-display">
    <span id="speed-value">0</span><span id="speed-unit">km/h</span>
  </div>

  <div id="radar-panel">
    <div id="radar-limit">50</div>
    <div id="radar-distance">Dans 500m</div>
  </div>

  <div id="gauge-container">
    <div id="radar-marker"></div>
    <div id="gauge-fill"></div>
  </div>

  <script>
    let radars = [];
    let currentPos = null;
    let currentSpeed = 0;
    let currentBearing = 0;
    let activeRadar = null;
    let lastBeepTime = 0;
    let audioContext = null;
    let debugMode = false;

    function toggleDebug() {
      debugMode = !debugMode;
      document.getElementById('debug-info').style.display = debugMode ? 'block' : 'none';
    }

    function updateDebug() {
      if (!debugMode) return;
      document.getElementById('dbg-heading').textContent = currentBearing.toFixed(0);
      document.getElementById('dbg-lat').textContent = currentPos ? currentPos.latitude.toFixed(4) : '--';
      document.getElementById('dbg-lon').textContent = currentPos ? currentPos.longitude.toFixed(4) : '--';
      document.getElementById('dbg-radars').textContent = radars.length;
    }

    function getAlertZone(radarSpeed) {
      if (radarSpeed >= 130) return { before: 2000, after: 100 };
      if (radarSpeed >= 110) return { before: 1500, after: 80 };
      if (radarSpeed >= 90) return { before: 1000, after: 70 };
      if (radarSpeed >= 70) return { before: 800, after: 60 };
      return { before: 500, after: 50 };
    }

    function closeModal() {
      document.getElementById('settings-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }

    function openModal() {
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('settings-modal').style.display = 'block';
      const key = localStorage.getItem('lufop_key');
      if (key) document.getElementById('api-key').value = key;
    }

    function clearData() {
      if (confirm('Effacer toutes les donn√©es ?')) {
        localStorage.clear();
        radars = [];
        updateStatusButton();
        alert('‚úÖ Donn√©es effac√©es');
      }
    }

    function initAudio() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    function beep(freq = 1000, duration = 200) {
      try {
        initAudio();
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, audioContext.currentTime);
        osc.start();
        setTimeout(() => osc.stop(), duration);
      } catch(e) {}
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function bearing(lat1, lon1, lat2, lon2) {
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
      const Œ∏ = Math.atan2(y, x);
      return (Œ∏ * 180 / Math.PI + 360) % 360;
    }

    // ALGORITHME CORRIG√â DE D√âTECTION
    function isRelevantRadar(radar) {
      if (!currentPos || !currentBearing) return false;

      const dist = haversine(currentPos.latitude, currentPos.longitude, radar.lat, radar.lon);
      const zone = getAlertZone(radar.speed);
      const maxDist = zone.before + zone.after;

      // Distance totale incluant avant et apr√®s
      if (dist > maxDist) return false;

      // Direction vers le radar depuis ma position
      const bearingToRadar = bearing(currentPos.latitude, currentPos.longitude, radar.lat, radar.lon);

      // Azimut du radar (direction qu'il surveille)
      const radarAzimut = parseFloat(radar.azimut || 0);

      // Mon heading (direction de d√©placement)
      const myHeading = currentBearing;

      // Diff√©rence entre ma direction et l'azimut du radar
      let headingDiff = Math.abs(myHeading - radarAzimut);
      if (headingDiff > 180) headingDiff = 360 - headingDiff;

      // Diff√©rence entre ma direction et la direction vers le radar
      let bearingDiff = Math.abs(myHeading - bearingToRadar);
      if (bearingDiff > 180) bearingDiff = 360 - bearingDiff;

      // Je me dirige vers le radar (ou je l'ai d√©pass√© de peu)
      const goingTowardsRadar = bearingDiff < 120; // Plus tol√©rant

      // Le radar surveille ma direction (ou sens inverse pour radars bidirectionnels)
      const radarPointsAtMe = headingDiff < 60; // Plus tol√©rant pour d√©tecter radars par derri√®re

      // Radar bidirectionnel
      const isBidirectional = radar.flash === 'D';

      // Exclure radars lat√©raux hors chauss√©e
      if (radar.position === 'L') return false;

      // Le radar est pertinent si:
      // - Je vais dans sa direction (ou je viens de le passer)
      // - ET (il est bidirectionnel OU il pointe vers moi)
      if (!goingTowardsRadar) return false;
      if (!isBidirectional && !radarPointsAtMe) return false;

      return true;
    }

    async function loadRadars() {
      const key = document.getElementById('api-key').value.trim();
      if (!key) {
        alert('‚ùå Cl√© API requise');
        openModal();
        return;
      }

      localStorage.setItem('lufop_key', key);

      const url = `https://api.allorigins.win/raw?url=${encodeURIComponent(
        'https://api.lufop.net/api?key=' + key + '&format=json&pays=fr&nbr=5000'
      )}`;

      try {
        document.getElementById('status-btn').textContent = 'Chargement...';
        document.getElementById('status-btn').className = 'status-orange';

        const response = await fetch(url);
        if (!response.ok) throw new Error('Erreur HTTP ' + response.status);

        const data = await response.json();

        radars = data.map(r => ({
          lat: parseFloat(r.latitude),
          lon: parseFloat(r.longitude),
          speed: parseInt(r.vitesse || 50),
          flash: r.flash || 'D',
          position: r.position || 'C',
          azimut: parseFloat(r.azimut || 0)
        }));

        localStorage.setItem('radars_cache', JSON.stringify(radars));
        localStorage.setItem('radars_date', new Date().toISOString());

        updateStatusButton();
        alert('‚úÖ ' + radars.length + ' radars charg√©s');
        closeModal();

      } catch(e) {
        alert('‚ùå Erreur: ' + e.message);
        document.getElementById('status-btn').textContent = 'Erreur';
        document.getElementById('status-btn').className = 'status-red';
      }
    }

    function updateStatusButton() {
      const date = localStorage.getItem('radars_date');
      const btn = document.getElementById('status-btn');

      if (!date || radars.length === 0) {
        btn.className = 'status-red';
        btn.textContent = 'Aucune donn√©e';
        return;
      }

      const days = (Date.now() - new Date(date)) / 86400000;
      if (days < 1) {
        btn.className = 'status-green';
        btn.textContent = radars.length + ' radars';
      } else if (days < 30) {
        btn.className = 'status-orange';
        btn.textContent = radars.length + ' (' + Math.floor(days) + 'j)';
      } else {
        btn.className = 'status-red';
        btn.textContent = 'MAJ requise';
      }
    }

    // Monitoring GPS
    navigator.geolocation.watchPosition(pos => {
      currentPos = pos.coords;
      currentSpeed = (pos.coords.speed || 0) * 3.6;
      currentBearing = pos.coords.heading || 0;

      updateDebug();

      document.getElementById('speed-value').textContent = Math.round(currentSpeed);

      // Filtrer les radars pertinents
      const relevant = radars.filter(isRelevantRadar)
        .map(r => ({
          ...r,
          distance: haversine(currentPos.latitude, currentPos.longitude, r.lat, r.lon)
        }))
        .sort((a, b) => a.distance - b.distance);

      if (debugMode) {
        document.getElementById('dbg-relevant').textContent = relevant.length;
      }

      if (relevant.length > 0) {
        const radar = relevant[0];
        const zone = getAlertZone(radar.speed);

        // Afficher si dans la zone d'alerte
        if (radar.distance <= zone.before + zone.after) {
          activeRadar = radar;

          // Affichage du panneau
          document.getElementById('radar-panel').style.display = 'block';
          document.getElementById('radar-limit').textContent = radar.speed;

          // Distance affich√©e
          const distDisplay = document.getElementById('radar-distance');
          if (radar.distance <= zone.before) {
            distDisplay.textContent = 'Dans ' + Math.round(radar.distance) + 'm';
            distDisplay.className = '';
          } else {
            const passedBy = Math.round(radar.distance - zone.before);
            distDisplay.textContent = 'D√©pass√© de ' + passedBy + 'm';
            distDisplay.className = 'passed';
          }

          // Couleur de fond selon vitesse
          if (currentSpeed <= radar.speed + 1) {
            document.body.className = 'bg-green';
          } else if (currentSpeed <= radar.speed + 5) {
            document.body.className = 'bg-orange';
          } else {
            document.body.className = 'bg-red';
          }

          // Barre de progression avec marqueur du radar
          const totalZone = zone.before + zone.after;
          let progress;

          if (radar.distance <= zone.before) {
            // Avant le radar: 0% (loin) √† 50% (au radar)
            progress = ((zone.before - radar.distance) / zone.before) * 50;
          } else {
            // Apr√®s le radar: 50% (au radar) √† 100% (fin de zone)
            const afterDist = radar.distance - zone.before;
            progress = 50 + (afterDist / zone.after) * 50;
          }

          progress = Math.max(0, Math.min(100, progress));
          document.getElementById('gauge-fill').style.width = progress + '%';

          // Marqueur du radar √† 50% (position du radar)
          const marker = document.getElementById('radar-marker');
          marker.style.display = 'block';
          marker.style.left = '50%';

          // Beep sonore
          const now = Date.now();
          if (radar.distance <= zone.before && radar.distance > zone.before * 0.8 && lastBeepTime === 0) {
            beep(1500, 300);
            lastBeepTime = now;
          }
          if (currentSpeed > radar.speed + 5 && now - lastBeepTime > 2000) {
            beep(2000, 200);
            lastBeepTime = now;
          }

        } else {
          resetDisplay();
        }
      } else {
        resetDisplay();
      }

    }, null, { enableHighAccuracy: true, maximumAge: 1000 });

    function resetDisplay() {
      activeRadar = null;
      document.getElementById('radar-panel').style.display = 'none';
      document.getElementById('radar-marker').style.display = 'none';
      document.body.className = '';
      document.getElementById('gauge-fill').style.width = '0%';
      lastBeepTime = 0;
    }

    // Chargement initial
    window.onload = () => {
      const cached = localStorage.getItem('radars_cache');
      if (cached) {
        try {
          radars = JSON.parse(cached);
          console.log('‚úÖ Radars charg√©s du cache:', radars.length);
        } catch(e) {
          console.error('Cache corrompu');
        }
      }
      updateStatusButton();
    };
  </script>

</body>
</html>
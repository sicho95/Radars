<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Radar Alert Pro</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
    }

    body { 
      background: #000; 
      color: #fff; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      transition: background 0.3s;
      touch-action: none;
    }

    #top-controls {
      position: fixed;
      top: 10vh;
      right: 10vw;
      display: flex;
      gap: clamp(6px, 2vw, 10px);
      z-index: 1000;
    }

    #status-btn {
      padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 18px);
      border: 2px solid #fff;
      border-radius: clamp(6px, 2vw, 10px);
      cursor: pointer;
      font-size: clamp(12px, 3vw, 16px);
      font-weight: bold;
      white-space: nowrap;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .status-green { background: #0a0; color: #fff; }
    .status-orange { background: #f80; color: #000; }
    .status-red { background: #f00; color: #fff; }

    #settings-btn, #debug-btn {
      width: clamp(35px, 10vw, 45px);
      height: clamp(35px, 10vw, 45px);
      border: 2px solid #0ff;
      border-radius: 50%;
      background: #222;
      color: #0ff;
      font-size: clamp(16px, 4vw, 22px);
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    #settings-btn:active, #debug-btn:active { 
      background: #0ff; 
      color: #000; 
    }

    #speed-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-weight: bold;
      text-shadow: 0 0 20px currentColor;
      line-height: 1;
    }
    #speed-value {
      font-size: clamp(100px, 25vw, 180px);
      display: block;
    }
    #speed-unit { 
      font-size: clamp(30px, 7vw, 50px);
      margin-left: 5px;
    }

    #radar-panel {
      position: fixed;
      bottom: clamp(80px, 20vh, 140px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.95);
      border: clamp(3px, 1vw, 5px) solid #fff;
      border-radius: clamp(12px, 3vw, 20px);
      padding: clamp(15px, 4vw, 25px) clamp(20px, 5vw, 35px);
      min-width: clamp(250px, 70vw, 350px);
      max-width: 90vw;
      text-align: center;
      display: none;
      box-shadow: 0 0 30px rgba(255,255,255,0.8);
    }
    #radar-limit {
      font-size: clamp(50px, 15vw, 80px);
      font-weight: bold;
      color: #f00;
      text-shadow: 0 0 15px #f00, 0 0 30px #f00;
      line-height: 1;
    }
    #radar-distance {
      font-size: clamp(20px, 5vw, 32px);
      margin-top: clamp(8px, 2vh, 12px);
      font-weight: bold;
    }
    #radar-distance.passed {
      color: #888;
      font-style: italic;
    }

    #gauge-container {
      position: fixed;
      bottom: 10vh;
      left: 5vw;
      right: 5vw;
      height: clamp(35px, 8vh, 50px);
      background: #222;
      border: clamp(2px, 0.5vw, 3px) solid #fff;
      border-radius: clamp(5px, 1.5vw, 8px);
      overflow: visible;
      box-shadow: 0 2px 15px rgba(0,0,0,0.5);
    }
    #gauge-fill {
      height: 100%;
      background: linear-gradient(90deg, #0f0, #ff0, #f00);
      width: 0%;
      transition: width 0.2s ease-out;
      border-radius: clamp(3px, 1vw, 6px);
    }

    #radar-marker {
      position: absolute;
      top: -3px;
      bottom: -3px;
      width: clamp(3px, 0.8vw, 5px);
      background: #fff;
      box-shadow: 0 0 10px #fff, 0 0 20px #fff;
      display: none;
      z-index: 10;
    }
    #radar-marker::before {
      content: 'üì∑';
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      font-size: clamp(16px, 4vw, 24px);
      filter: drop-shadow(0 0 5px #000);
    }

    .bg-green { background: #0a0 !important; }
    .bg-orange { background: #f80 !important; }
    .bg-red { background: #f00 !important; }

    #modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1999;
      display: none;
    }

    #settings-modal {
      position: fixed;
      top: 5%;
      left: 5%;
      right: 5%;
      bottom: 5%;
      max-height: 90vh;
      background: #111;
      border: 3px solid #0ff;
      border-radius: clamp(8px, 2vw, 15px);
      z-index: 2000;
      display: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #tab-container {
      display: flex;
      border-bottom: 2px solid #0ff;
      background: #000;
    }
    .tab-button {
      flex: 1;
      padding: clamp(12px, 3vh, 16px);
      background: #222;
      border: none;
      color: #888;
      font-size: clamp(14px, 3.5vw, 18px);
      font-weight: bold;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    .tab-button.active {
      background: #111;
      color: #0ff;
      border-bottom-color: #0ff;
    }
    .tab-button:first-child {
      border-radius: clamp(8px, 2vw, 15px) 0 0 0;
    }
    .tab-button:last-child {
      border-radius: 0 clamp(8px, 2vw, 15px) 0 0;
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: clamp(12px, 3vw, 20px);
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    #settings-modal h3 {
      color: #0ff;
      font-size: clamp(18px, 4.5vw, 24px);
      margin-bottom: clamp(12px, 3vh, 20px);
      border-bottom: 2px solid #0ff;
      padding-bottom: clamp(8px, 2vh, 12px);
    }

    #settings-modal h4 {
      color: #ff0;
      font-size: clamp(14px, 3.5vw, 18px);
      margin: clamp(12px, 3vh, 18px) 0 clamp(6px, 1.5vh, 10px) 0;
    }

    #settings-modal label {
      display: block;
      color: #aaa;
      font-size: clamp(12px, 3vw, 15px);
      margin-bottom: 5px;
      line-height: 1.4;
    }

    #settings-modal input[type="text"],
    #settings-modal input[type="number"],
    #settings-modal select {
      width: 100%;
      padding: clamp(10px, 2.5vw, 14px);
      margin-bottom: clamp(8px, 2vh, 12px);
      background: #222;
      border: 2px solid #fff;
      color: #fff;
      font-size: clamp(14px, 3.5vw, 18px);
      border-radius: clamp(5px, 1.5vw, 8px);
    }

    #settings-modal button {
      width: 100%;
      padding: clamp(12px, 3vw, 16px);
      border: none;
      color: #fff;
      font-size: clamp(14px, 3.5vw, 18px);
      cursor: pointer;
      border-radius: clamp(5px, 1.5vw, 8px);
      margin: clamp(5px, 1.5vh, 8px) 0;
      font-weight: bold;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: clamp(8px, 2vw, 12px);
      padding: clamp(10px, 2.5vw, 14px);
      background: #222;
      border: 2px solid #fff;
      border-radius: clamp(5px, 1.5vw, 8px);
      margin-bottom: clamp(8px, 2vh, 12px);
      cursor: pointer;
    }
    .checkbox-container input[type="checkbox"] {
      width: clamp(18px, 4vw, 24px);
      height: clamp(18px, 4vw, 24px);
      cursor: pointer;
    }
    .checkbox-container label {
      margin: 0;
      cursor: pointer;
      font-size: clamp(13px, 3.2vw, 16px);
      color: #fff;
    }

    .radius-group {
      margin-left: clamp(15px, 4vw, 25px);
      padding: clamp(8px, 2vw, 12px);
      background: #1a1a1a;
      border-left: 3px solid #0ff;
      border-radius: clamp(5px, 1.5vw, 8px);
      margin-bottom: clamp(8px, 2vh, 12px);
    }
    .radius-group.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    #btn-validate { background: #0a0; }
    #btn-clear { background: #f80; }
    #btn-close { background: #666; }

    .info-box {
      background: #222;
      border-left: 4px solid #0ff;
      padding: clamp(8px, 2vw, 12px);
      margin: clamp(8px, 2vh, 12px) 0;
      font-size: clamp(11px, 2.8vw, 14px);
      line-height: 1.5;
      border-radius: clamp(3px, 1vw, 5px);
    }
    .info-box.warning { border-left-color: #ff0; }
    .info-box.success { border-left-color: #0f0; }
    .info-box.danger { border-left-color: #f00; }

    #debug-info {
      position: fixed;
      top: 10vh;
      left: 5vw;
      background: rgba(0,0,0,0.9);
      padding: clamp(8px, 2vw, 12px);
      border: 2px solid #0ff;
      border-radius: clamp(5px, 1.5vw, 8px);
      font-family: 'Courier New', monospace;
      font-size: clamp(10px, 2.5vw, 13px);
      display: none;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    #debug-info div {
      margin: clamp(2px, 0.5vh, 4px) 0;
      white-space: nowrap;
    }

    #debug-log {
      background: #000;
      border: 2px solid #0f0;
      border-radius: clamp(5px, 1.5vw, 8px);
      padding: clamp(8px, 2vw, 12px);
      min-height: 200px;
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      font-family: 'Courier New', monospace;
      font-size: clamp(10px, 2.5vw, 12px);
      text-align: left;
      line-height: 1.5;
    }
    .log-entry {
      margin: 3px 0;
      padding: 3px 0;
      border-bottom: 1px solid #222;
    }
    .log-info { color: #0ff; }
    .log-success { color: #0f0; }
    .log-warning { color: #ff0; }
    .log-error { color: #f00; }
    .log-time { color: #888; font-size: 10px; margin-right: 5px; }

    @media (orientation: landscape) {
      #speed-value {
        font-size: clamp(80px, 18vh, 140px);
      }
      #speed-unit {
        font-size: clamp(25px, 5vh, 40px);
      }
      #radar-panel {
        bottom: clamp(70px, 15vh, 100px);
      }
      #radar-limit {
        font-size: clamp(40px, 12vh, 60px);
      }
      #radar-distance {
        font-size: clamp(16px, 4vh, 24px);
      }
    }

    @media (max-width: 375px) {
      #top-controls {
        top: 5vh;
        right: 5vw;
        gap: 5px;
      }
      #status-btn {
        font-size: 11px;
        padding: 6px 10px;
      }
      #debug-info {
        left: 3vw;
        font-size: 9px;
      }
    }

    @media (min-width: 768px) {
      #speed-value {
        font-size: clamp(120px, 20vw, 200px);
      }
      #gauge-container {
        left: 10vw;
        right: 10vw;
      }
    }
  </style>
</head>
<body>

  <div id="modal-overlay"></div>

  <div id="settings-modal">
    <div id="tab-container">
      <button class="tab-button active" onclick="switchTab('settings')">‚öôÔ∏è Param√®tres</button>
      <button class="tab-button" onclick="switchTab('logs')">üìã Journal</button>
    </div>

    <div id="tab-settings" class="tab-content active">
      <h3>‚öôÔ∏è Configuration</h3>

      <h4>üîå Source API</h4>
      <select id="api-source">
        <option value="lufop" selected>Lufop API (officielle)</option>
        <option value="blitzer">Blitzer.de (non officielle ‚ö†Ô∏è)</option>
      </select>

      <div class="info-box danger" id="blitzer-warning" style="display:none">
        ‚ö†Ô∏è <b>Blitzer.de non officielle</b> - peut cesser de fonctionner √† tout moment
      </div>

      <h4>üîë Cl√© API (Lufop uniquement)</h4>
      <input type="text" id="api-key" placeholder="Cl√© API Lufop (32 caract√®res)">

      <h4>üåê Proxy CORS (avec fallback automatique)</h4>
      <select id="cors-proxy">
        <option value="allorigins" selected>AllOrigins (recommand√©)</option>
        <option value="corsproxy">CorsProxy.io</option>
        <option value="codetabs">CodeTabs Proxy</option>
        <option value="corsh">CORS.SH</option>
      </select>

      <div class="info-box warning">
        ‚öôÔ∏è <b>Fallback automatique :</b><br>
        Si le proxy choisi √©choue, l'app essaiera automatiquement les 3 autres dans l'ordre.<br>
        Timeout : 120 secondes par tentative.
      </div>

      <h4>üåç Zone g√©ographique</h4>

      <div class="checkbox-container" onclick="document.getElementById('limit-france').click()">
        <input type="checkbox" id="limit-france" checked onclick="event.stopPropagation()">
        <label for="limit-france">Limiter √† la France</label>
      </div>

      <div class="checkbox-container" onclick="document.getElementById('use-radius').click()">
        <input type="checkbox" id="use-radius" onclick="event.stopPropagation(); toggleRadius()">
        <label for="use-radius">Limiter par rayon</label>
      </div>

      <div class="radius-group disabled" id="radius-group">
        <label>Rayon en km (10-5000)</label>
        <input type="number" id="radius-km" placeholder="1000" min="10" max="5000" value="1000">
      </div>

      <h4>üîç Zoom Blitzer.de (1=large, 15=d√©taill√©)</h4>
      <input type="number" id="zoom-level" placeholder="8" min="1" max="15" value="8">

      <h4>üìä Nombre max de radars</h4>
      <input type="number" id="radar-count" placeholder="5000" min="100" max="25000" value="5000">

      <div class="info-box success">
        ‚úÖ <b>Zones d'alerte variables :</b><br>
        ‚Ä¢ ‚â•130 km/h: 2000m avant / 100m apr√®s<br>
        ‚Ä¢ 110 km/h: 1500m / 80m<br>
        ‚Ä¢ 90 km/h: 1000m / 70m<br>
        ‚Ä¢ 70-89 km/h: 800m / 60m<br>
        ‚Ä¢ <70 km/h: 500m / 50m
      </div>

      <button id="btn-validate" onclick="saveSettings()">‚úì VALIDER ET CHARGER</button>
      <button id="btn-clear" onclick="clearData()">üóëÔ∏è EFFACER CACHE</button>
      <button id="btn-close" onclick="closeModal()">‚úï FERMER</button>
    </div>

    <div id="tab-logs" class="tab-content">
      <h3>üìã Journal de d√©bogage d√©taill√©</h3>
      <div id="debug-log">
        <div class="log-entry log-info"><span class="log-time">--:--:--</span> ‚ÑπÔ∏è Application d√©marr√©e</div>
      </div>
    </div>
  </div>

  <div id="top-controls">
    <div id="status-btn" class="status-red" onclick="saveSettings()">Pas de donn√©es</div>
    <div id="settings-btn" onclick="openModal()">‚öô</div>
    <div id="debug-btn" onclick="toggleDebug()">üêõ</div>
  </div>

  <div id="debug-info">
    <div><b>üìç Position GPS</b></div>
    <div>Lat: <span id="dbg-lat">--</span></div>
    <div>Lon: <span id="dbg-lon">--</span></div>
    <div>Alt: <span id="dbg-alt">--</span>m</div>
    <div><b>üß≠ Navigation</b></div>
    <div>Heading: <span id="dbg-heading">--</span>¬∞</div>
    <div>Speed: <span id="dbg-speed">--</span> km/h</div>
    <div>Accuracy: <span id="dbg-accuracy">--</span>m</div>
    <div><b>üì° Donn√©es</b></div>
    <div>Radars: <span id="dbg-radars">0</span></div>
    <div>Relevant: <span id="dbg-relevant">0</span></div>
    <div>GPS refresh: <span id="dbg-refresh">--</span>ms</div>
  </div>

  <div id="speed-display">
    <span id="speed-value">0</span><span id="speed-unit">km/h</span>
  </div>

  <div id="radar-panel">
    <div id="radar-limit">50</div>
    <div id="radar-distance">Dans 500m</div>
  </div>

  <div id="gauge-container">
    <div id="radar-marker"></div>
    <div id="gauge-fill"></div>
  </div>

  <script>
    let radars = [];
    let currentPos = null;
    let currentSpeed = 0;
    let currentBearing = 0;
    let activeRadar = null;
    let lastBeepTime = 0;
    let audioContext = null;
    let debugMode = false;
    let lastGPSUpdate = Date.now();
    let gpsRefreshRate = 0;
    let currentTab = 'settings';

    // Configuration des proxies CORS
    const PROXIES = {
      allorigins: (url) => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url),
      corsproxy: (url) => 'https://corsproxy.io/?' + encodeURIComponent(url),
      codetabs: (url) => 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url),
      corsh: (url) => 'https://cors.sh/' + url
    };

    function switchTab(tabName) {
      currentTab = tabName;

      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      if (tabName === 'settings') {
        document.querySelector('.tab-button:first-child').classList.add('active');
        document.getElementById('tab-settings').classList.add('active');
      } else {
        document.querySelector('.tab-button:last-child').classList.add('active');
        document.getElementById('tab-logs').classList.add('active');
      }

      addLog('Onglet ' + (tabName === 'settings' ? 'Param√®tres' : 'Journal') + ' affich√©', 'info');
    }

    function addLog(msg, type = 'info') {
      console.log('[' + type + ']', msg);
      const log = document.getElementById('debug-log');
      if (!log) return;

      const time = new Date().toLocaleTimeString('fr-FR');
      const logClass = 'log-' + type;
      const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

      const entry = document.createElement('div');
      entry.className = 'log-entry ' + logClass;
      entry.innerHTML = '<span class="log-time">' + time + '</span>' + icon + ' ' + msg;

      log.insertBefore(entry, log.firstChild);

      while (log.children.length > 200) {
        log.removeChild(log.lastChild);
      }
    }

    function toggleDebug() {
      debugMode = !debugMode;
      document.getElementById('debug-info').style.display = debugMode ? 'block' : 'none';
      if (debugMode) {
        addLog('Mode debug activ√©', 'info');
      }
    }

    function toggleRadius() {
      const checkbox = document.getElementById('use-radius');
      document.getElementById('radius-group').classList.toggle('disabled', !checkbox.checked);
    }

    function getAlertZone(radarSpeed) {
      if (radarSpeed >= 130) return { before: 2000, after: 100 };
      if (radarSpeed >= 110) return { before: 1500, after: 80 };
      if (radarSpeed >= 90) return { before: 1000, after: 70 };
      if (radarSpeed >= 70) return { before: 800, after: 60 };
      return { before: 500, after: 50 };
    }

    function closeModal() {
      document.getElementById('settings-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
      addLog('Modal ferm√©e', 'info');
    }

    function openModal() {
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('settings-modal').style.display = 'flex';

      document.getElementById('api-source').value = localStorage.getItem('api_source') || 'lufop';
      document.getElementById('cors-proxy').value = localStorage.getItem('cors_proxy') || 'allorigins';
      document.getElementById('api-key').value = localStorage.getItem('lufop_key') || '';
      document.getElementById('radar-count').value = localStorage.getItem('radar_count') || '5000';
      document.getElementById('limit-france').checked = localStorage.getItem('limit_france') !== 'false';
      document.getElementById('use-radius').checked = localStorage.getItem('use_radius') === 'true';
      document.getElementById('radius-km').value = localStorage.getItem('radius_km') || '1000';
      document.getElementById('zoom-level').value = localStorage.getItem('zoom_level') || '8';

      if (document.getElementById('use-radius').checked) {
        document.getElementById('radius-group').classList.remove('disabled');
      }

      document.getElementById('blitzer-warning').style.display = 
        document.getElementById('api-source').value === 'blitzer' ? 'block' : 'none';

      addLog('Modal ouverte', 'info');
    }

    document.getElementById('api-source').addEventListener('change', () => {
      document.getElementById('blitzer-warning').style.display = 
        document.getElementById('api-source').value === 'blitzer' ? 'block' : 'none';
    });

    function clearData() {
      if (confirm('Effacer toutes les donn√©es ?')) {
        localStorage.clear();
        radars = [];
        updateStatusButton();
        addLog('Cache et donn√©es effac√©s', 'success');
        alert('‚úÖ Donn√©es effac√©es');
      }
    }

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        addLog('Audio context initialis√©', 'success');
      }
    }

    function beep(freq = 1000, duration = 200) {
      try {
        initAudio();
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, audioContext.currentTime);
        osc.start();
        setTimeout(() => osc.stop(), duration);
        addLog('Alerte sonore: ' + freq + 'Hz', 'warning');
      } catch(e) {
        addLog('Erreur audio: ' + e.message, 'error');
      }
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function bearing(lat1, lon1, lat2, lon2) {
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
      const Œ∏ = Math.atan2(y, x);
      return (Œ∏ * 180 / Math.PI + 360) % 360;
    }

    function isRelevantRadar(radar) {
      if (!currentPos || currentBearing === null) return false;

      const dist = haversine(currentPos.latitude, currentPos.longitude, radar.lat, radar.lon);
      const zone = getAlertZone(radar.speed);
      const maxDist = zone.before + zone.after;

      if (dist > maxDist) return false;

      const bearingToRadar = bearing(currentPos.latitude, currentPos.longitude, radar.lat, radar.lon);
      const radarAzimut = parseFloat(radar.azimut || 0);
      const myHeading = currentBearing;

      let headingDiff = Math.abs(myHeading - radarAzimut);
      if (headingDiff > 180) headingDiff = 360 - headingDiff;

      let bearingDiff = Math.abs(myHeading - bearingToRadar);
      if (bearingDiff > 180) bearingDiff = 360 - bearingDiff;

      const goingTowardsRadar = bearingDiff < 120;
      const radarPointsAtMe = headingDiff < 60;
      const isBidirectional = radar.flash === 'D';

      if (radar.position === 'L') return false;
      if (!goingTowardsRadar) return false;
      if (!isBidirectional && !radarPointsAtMe) return false;

      return true;
    }

    async function fetchWithProxy(url, proxyName, timeout = 120000) {
      const proxyFn = PROXIES[proxyName];
      if (!proxyFn) throw new Error('Proxy inconnu: ' + proxyName);

      const proxyUrl = proxyFn(url);
      addLog('üîÑ Tentative avec proxy: ' + proxyName, 'info');
      addLog('URL: ' + proxyUrl.substring(0, 150) + '...', 'info');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);

      try {
        const startTime = Date.now();
        const r = await fetch(proxyUrl, { 
          signal: controller.signal,
          headers: {
            'Accept': 'application/json',
            'User-Agent': 'RadarAlertPro/2.2'
          }
        });
        clearTimeout(timeoutId);

        const elapsed = Date.now() - startTime;
        addLog('‚úÖ R√©ponse re√ßue en ' + elapsed + 'ms via ' + proxyName, 'success');
        addLog('Status: ' + r.status + ' ' + r.statusText, r.ok ? 'success' : 'error');

        if (!r.ok) {
          const errorBody = await r.text();
          addLog('Body erreur: ' + errorBody.substring(0, 300), 'error');
          throw new Error('HTTP ' + r.status + ' ' + r.statusText);
        }

        return r;

      } catch(e) {
        clearTimeout(timeoutId);
        if (e.name === 'AbortError') {
          addLog('‚è±Ô∏è TIMEOUT apr√®s ' + (timeout/1000) + 's avec ' + proxyName, 'error');
          throw new Error('TIMEOUT');
        }
        addLog('‚ùå √âchec ' + proxyName + ': ' + e.message, 'error');
        throw e;
      }
    }

    async function fetchWithFallback(url) {
      const preferredProxy = localStorage.getItem('cors_proxy') || 'allorigins';
      const proxyList = Object.keys(PROXIES);

      // Mettre le proxy pr√©f√©r√© en premier
      const orderedProxies = [preferredProxy, ...proxyList.filter(p => p !== preferredProxy)];

      addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
      addLog('üåê Fallback automatique activ√©', 'warning');
      addLog('Ordre: ' + orderedProxies.join(' ‚Üí '), 'info');

      for (let i = 0; i < orderedProxies.length; i++) {
        const proxyName = orderedProxies[i];
        addLog('üì° Tentative ' + (i+1) + '/' + orderedProxies.length + ': ' + proxyName, 'warning');

        try {
          const response = await fetchWithProxy(url, proxyName);
          addLog('üéâ SUCC√àS avec ' + proxyName + '!', 'success');
          return response;
        } catch(e) {
          addLog('üí• √âchec ' + proxyName + ': ' + e.message, 'error');

          if (i < orderedProxies.length - 1) {
            addLog('‚è≠Ô∏è Passage au proxy suivant...', 'warning');
          } else {
            addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'error');
            addLog('üíÄ TOUS LES PROXIES ONT √âCHOU√â', 'error');
            throw new Error('Tous les proxies ont √©chou√©');
          }
        }
      }
    }

    async function saveSettings() {
      const apiSource = document.getElementById('api-source').value;
      const proxy = document.getElementById('cors-proxy').value;
      const key = document.getElementById('api-key').value.trim();
      const nbr = document.getElementById('radar-count').value;
      const fr = document.getElementById('limit-france').checked;
      const useR = document.getElementById('use-radius').checked;
      const km = document.getElementById('radius-km').value;
      const zoom = document.getElementById('zoom-level').value;

      if (apiSource === 'lufop' && !key) {
        addLog('Cl√© API manquante', 'error');
        alert('‚ùå Cl√© API requise');
        openModal();
        return;
      }

      addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
      addLog('üíæ Sauvegarde param√®tres', 'info');
      addLog('API: ' + apiSource + ', Proxy: ' + proxy, 'info');
      addLog('Radars max: ' + nbr + ', France: ' + fr, 'info');

      localStorage.setItem('api_source', apiSource);
      localStorage.setItem('cors_proxy', proxy);
      localStorage.setItem('lufop_key', key);
      localStorage.setItem('radar_count', nbr);
      localStorage.setItem('limit_france', fr);
      localStorage.setItem('use_radius', useR);
      localStorage.setItem('radius_km', km);
      localStorage.setItem('zoom_level', zoom);

      document.getElementById('status-btn').textContent = 'Chargement...';
      document.getElementById('status-btn').className = 'status-orange';

      if (apiSource === 'lufop') await loadLufop();
      else await loadBlitzer();
    }

    async function loadLufop() {
      const key = localStorage.getItem('lufop_key');
      const nbr = localStorage.getItem('radar_count') || '5000';
      const fr = localStorage.getItem('limit_france') !== 'false';
      const useR = localStorage.getItem('use_radius') === 'true';
      const km = localStorage.getItem('radius_km') || '1000';

      let url = 'https://api.lufop.net/api?key=' + key + '&format=json&nbr=' + nbr;

      if (fr && useR) {
        if (!currentPos) { 
          addLog('Position GPS requise pour mode rayon', 'error');
          alert('GPS requis'); 
          return; 
        }
        url += '&pays=fr&q=' + currentPos.latitude + ',' + currentPos.longitude + '&m=' + km;
      } else if (useR) {
        if (!currentPos) { 
          addLog('Position GPS requise pour mode rayon', 'error');
          alert('GPS requis'); 
          return; 
        }
        url += '&q=' + currentPos.latitude + ',' + currentPos.longitude + '&m=' + km;
      } else if (fr) {
        url += '&pays=fr';
      }

      addLog('URL API: ' + url, 'info');

      try {
        addLog('üì° D√©marrage chargement Lufop (timeout 120s)...', 'info');
        const startTime = Date.now();

        const r = await fetchWithFallback(url);

        const elapsed = Date.now() - startTime;

        const text = await r.text();
        addLog('Taille r√©ponse: ' + Math.round(text.length / 1024) + ' Ko', 'info');

        const data = JSON.parse(text);
        addLog('JSON pars√©: ' + data.length + ' radars', 'success');

        radars = data.map(x => ({
          lat: parseFloat(x.lat || x.latitude), 
          lon: parseFloat(x.lng || x.lon || x.longitude),
          speed: parseInt(x.vitesse || x.speed || 50), 
          flash: x.flash || 'D',
          position: x.position || x.emplacement || 'C', 
          azimut: parseFloat(x.azimut || 0)
        }));

        localStorage.setItem('radars_cache', JSON.stringify(radars));
        localStorage.setItem('radars_date', new Date().toISOString());
        updateStatusButton();

        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
        addLog('üéâ SUCC√àS TOTAL! ' + radars.length + ' radars en ' + elapsed + 'ms', 'success');
        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');

        alert('‚úÖ ' + radars.length + ' radars charg√©s');
        closeModal();
      } catch(e) {
        let errorMsg = e.message || e.toString();

        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'error');
        addLog('üí• √âCHEC TOTAL: ' + errorMsg, 'error');
        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'error');

        alert('‚ùå ' + errorMsg);
        document.getElementById('status-btn').textContent = 'Erreur';
        document.getElementById('status-btn').className = 'status-red';
      }
    }

    async function loadBlitzer() {
      if (!currentPos) { 
        addLog('Position GPS requise pour Blitzer', 'error');
        alert('GPS requis'); 
        return; 
      }

      const km = parseFloat(localStorage.getItem('radius_km') || '1000');
      const zoom = parseInt(localStorage.getItem('zoom_level') || '8');

      const deg = km / 111;
      const lat = currentPos.latitude, lon = currentPos.longitude;
      const latMin = Math.max(-90, lat - deg);
      const latMax = Math.min(90, lat + deg);
      const lonMin = Math.max(-180, lon - deg);
      const lonMax = Math.min(180, lon + deg);
      const box = latMin + ',' + lonMin + ',' + latMax + ',' + lonMax;

      const url = 'https://cdn2.atudo.net/api/4.0/pois.php?z=' + zoom + '&type=0,1,2,3,4,5,6,101,102,103&box=' + box;

      try {
        addLog('üì° D√©marrage Blitzer (timeout 120s)...', 'info');
        const startTime = Date.now();

        const r = await fetchWithFallback(url);

        const elapsed = Date.now() - startTime;

        const data = await r.json();
        const pois = data.pois ? Object.values(data.pois) : (Array.isArray(data) ? data : []);

        radars = pois.slice(0, parseInt(localStorage.getItem('radar_count') || '5000')).map(x => ({
          lat: parseFloat(x.lat || x.latitude || 0),
          lon: parseFloat(x.lng || x.lon || x.longitude || 0),
          speed: parseInt(x.speed || x.vmax || 50),
          flash: 'D', position: 'C', azimut: 0
        }));

        localStorage.setItem('radars_cache', JSON.stringify(radars));
        localStorage.setItem('radars_date', new Date().toISOString());
        updateStatusButton();

        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
        addLog('üéâ SUCC√àS! ' + radars.length + ' radars (Blitzer) en ' + elapsed + 'ms', 'success');
        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');

        alert('‚úÖ ' + radars.length + ' radars (Blitzer)');
        closeModal();
      } catch(e) {
        let errorMsg = e.message || e.toString();

        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'error');
        addLog('üí• √âCHEC Blitzer: ' + errorMsg, 'error');
        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'error');

        alert('‚ùå ' + errorMsg);
        document.getElementById('status-btn').textContent = 'Erreur';
        document.getElementById('status-btn').className = 'status-red';
      }
    }

    function updateStatusButton() {
      const date = localStorage.getItem('radars_date');
      const btn = document.getElementById('status-btn');

      if (!date || radars.length === 0) {
        btn.className = 'status-red';
        btn.textContent = 'Pas de donn√©es';
        return;
      }

      const days = (Date.now() - new Date(date)) / 86400000;
      if (days < 1) {
        btn.className = 'status-green';
        btn.textContent = radars.length + ' radars';
      } else if (days < 30) {
        btn.className = 'status-orange';
        btn.textContent = radars.length + ' (' + Math.floor(days) + 'j)';
      } else {
        btn.className = 'status-red';
        btn.textContent = 'MAJ requise';
      }
    }

    navigator.geolocation.watchPosition(pos => {
      const now = Date.now();
      gpsRefreshRate = now - lastGPSUpdate;
      lastGPSUpdate = now;

      currentPos = pos.coords;
      currentSpeed = (pos.coords.speed || 0) * 3.6;
      currentBearing = pos.coords.heading || 0;

      if (debugMode) {
        document.getElementById('dbg-heading').textContent = currentBearing.toFixed(0);
        document.getElementById('dbg-lat').textContent = currentPos.latitude.toFixed(6);
        document.getElementById('dbg-lon').textContent = currentPos.longitude.toFixed(6);
        document.getElementById('dbg-alt').textContent = (currentPos.altitude || 0).toFixed(0);
        document.getElementById('dbg-speed').textContent = currentSpeed.toFixed(1);
        document.getElementById('dbg-accuracy').textContent = (currentPos.accuracy || 0).toFixed(0);
        document.getElementById('dbg-radars').textContent = radars.length;
        document.getElementById('dbg-refresh').textContent = gpsRefreshRate;
      }

      document.getElementById('speed-value').textContent = Math.round(currentSpeed);

      const relevant = radars.filter(isRelevantRadar)
        .map(r => ({
          ...r,
          distance: haversine(currentPos.latitude, currentPos.longitude, r.lat, r.lon)
        }))
        .sort((a, b) => a.distance - b.distance);

      if (debugMode) {
        document.getElementById('dbg-relevant').textContent = relevant.length;
      }

      if (relevant.length > 0) {
        const radar = relevant[0];
        const zone = getAlertZone(radar.speed);

        if (radar.distance <= zone.before + zone.after) {
          if (!activeRadar || activeRadar !== radar) {
            addLog('üö® Radar d√©tect√©: ' + radar.speed + 'km/h √† ' + Math.round(radar.distance) + 'm', 'warning');
          }
          activeRadar = radar;

          document.getElementById('radar-panel').style.display = 'block';
          document.getElementById('radar-limit').textContent = radar.speed;

          if (radar.distance <= zone.before) {
            document.getElementById('radar-distance').textContent = 'Dans ' + Math.round(radar.distance) + 'm';
            document.getElementById('radar-distance').className = '';
          } else {
            document.getElementById('radar-distance').textContent = 'D√©pass√© de ' + Math.round(radar.distance - zone.before) + 'm';
            document.getElementById('radar-distance').className = 'passed';
          }

          if (currentSpeed <= radar.speed + 1) {
            document.body.className = 'bg-green';
          } else if (currentSpeed <= radar.speed + 5) {
            document.body.className = 'bg-orange';
          } else {
            document.body.className = 'bg-red';
          }

          const totalZone = zone.before + zone.after;
          let progress = ((totalZone - radar.distance) / totalZone) * 100;
          progress = Math.max(0, Math.min(100, progress));
          document.getElementById('gauge-fill').style.width = progress + '%';

          const radarPosition = (zone.before / totalZone) * 100;
          document.getElementById('radar-marker').style.display = 'block';
          document.getElementById('radar-marker').style.left = radarPosition + '%';

          const nowBeep = Date.now();
          if (radar.distance <= zone.before && radar.distance > zone.before * 0.8 && lastBeepTime === 0) {
            beep(1500, 300);
            lastBeepTime = nowBeep;
          }
          if (currentSpeed > radar.speed + 5 && nowBeep - lastBeepTime > 2000) {
            beep(2000, 200);
            lastBeepTime = nowBeep;
          }

        } else {
          resetDisplay();
        }
      } else {
        resetDisplay();
      }

    }, 
    (error) => {
      const errCodes = ['PERMISSION_DENIED', 'POSITION_UNAVAILABLE', 'TIMEOUT'];
      const errName = errCodes[error.code - 1] || 'UNKNOWN';
      addLog('‚ùå Erreur GPS [' + errName + ' (code ' + error.code + ')]: ' + error.message, 'error');
    }, 
    { 
      enableHighAccuracy: true, 
      maximumAge: 500,
      timeout: 10000 
    });

    function resetDisplay() {
      if (activeRadar) {
        addLog('Radar quitt√©', 'info');
      }
      activeRadar = null;
      document.getElementById('radar-panel').style.display = 'none';
      document.getElementById('radar-marker').style.display = 'none';
      document.body.className = '';
      document.getElementById('gauge-fill').style.width = '0%';
      lastBeepTime = 0;
    }

    window.onload = () => {
      addLog('üöÄ Radar Alert Pro d√©marr√©', 'success');
      addLog('Version: 2.2 - Multi-proxy fallback + Timeout 120s', 'info');

      const cached = localStorage.getItem('radars_cache');
      if (cached) {
        try {
          radars = JSON.parse(cached);
          addLog('üì¶ Cache charg√©: ' + radars.length + ' radars', 'success');
        } catch(e) {
          addLog('‚ùå Cache corrompu: ' + e.message, 'error');
        }
      }
      updateStatusButton();

      addLog('GPS: Attente position initiale...', 'info');
    };
  </script>

</body>
</html>